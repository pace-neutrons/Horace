# ===  Test directories should appear in one of:                       ===
# ===   - HERBERT_TESTS         (Herbert code unit tests)              ===
# ===   - HERBERT_SYSTEM_TESTS  (Herbert code system tests)            ===
# ===   - HORACE_TESTS          (Horace code unit tests)               ===
# ===   - HORACE_SYSTEM_TESTS   (Horace code system tests)             ===


set(HERBERT_TESTS
    "test_admin"
    "test_data_loaders"
)

set(HORACE_TESTS
    "test_algorithms"
    "test_ascii_column_data"
)


#-------------------------------------------------------------------------------
# Combine all the tests into single variable
set(TEST_SUITES
    "${HERBERT_TESTS}"
    "${HERBERT_SYSTEM_TESTS}"
    "${HORACE_TESTS}"
    "${HORACE_SYSTEM_TESTS}"
)

# ------------------------------------------------------------------------------
# Add the local_init directory - which contains worker_v4 and herbert_on -
# to the MATLABPATH environment variable when tests are run.
# This adds the paths to every new Matlab session, so parallel workers can
# access the scripts in tests.
# LOCAL_INIT_DIR is defined in the top-level CMakeLists
file(TO_CMAKE_PATH "$ENV{MATLABPATH}" MATLAB_PATH)
if(WIN32)
    set(MATLAB_PATH "${MATLAB_PATH}\;${LOCAL_INIT_DIR}")
else()
    set(MATLAB_PATH "${MATLAB_PATH}:${LOCAL_INIT_DIR}")
endif()

set(ENV_VARIABLES
    # paths automatically added to Matlab path
    "MATLABPATH=${MATLAB_PATH}"
    # temporary directory for Matlab - prevents read/write collisions on Jenkins
    "TMP=${CMAKE_BINARY_DIR}/tests"
)

    set(TEST_NAME "Matlab.${_test_dir}")
    matlab_add_unit_test(
        NAME "${TEST_NAME}"
        CUSTOM_TEST_COMMAND "validate_horace ${_test_dir} -talkative -disp_skipped -forcemex -exit_on_completion"
        ADDITIONAL_PATH "${Horace_ROOT}/admin"
    set_tests_properties("${TEST_NAME}"
        PROPERTIES
            ENVIRONMENT "${ENV_VARIABLES}"
    )
endforeach()
