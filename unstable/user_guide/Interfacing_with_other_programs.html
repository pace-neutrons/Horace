<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interfacing with other programs &mdash; Horace  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Example scripts" href="Example_scripts.html" />
    <link rel="prev" title="Resolution Convolution" href="Resolution_convolution.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Horace
            <img src="../_static/150px-Quintus_Horatius_Flaccus.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction and Setup</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../User_guide.html">User’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Getting_started.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="Horace_GUI.html">Horace GUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="Advanced_use.html">Advanced use</a></li>
<li class="toctree-l2"><a class="reference internal" href="Resolution_convolution.html">Resolution Convolution</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Interfacing with other programs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#recap-on-evaluating-functions-on-a-horace-workspace">Recap on evaluating functions on a Horace workspace</a></li>
<li class="toctree-l3"><a class="reference internal" href="#energy-convolution">Energy convolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#euphonic-example">Euphonic example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installing-euphonic">Installing Euphonic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-a-euphonic-calculation-with-horace">Running a Euphonic calculation with Horace</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fitting-data-with-euphonic-and-horace">Fitting data with Euphonic and Horace</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#spinw-example">SpinW example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installing-spinw">Installing SpinW</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-a-spinw-calculation-with-horace">Running a SpinW calculation with Horace</a></li>
<li class="toctree-l4"><a class="reference internal" href="#worked-example-with-resolution-convolution">Worked example with resolution convolution</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#generic-interface">Generic interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#matlab-function">Matlab function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#python-function">Python function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c-c-fortran-function">C / C++ / Fortran function</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Example_scripts.html">Example scripts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Horace_manual.html">Horace Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Citing.html">Citing Horace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developers.html">For Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API_Reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../General_disclaimer.html">General disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Privacy_policy.html">Privacy Policy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Horace</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../User_guide.html">User’s Guide</a> &raquo;</li>
      <li>Interfacing with other programs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user_guide/Interfacing_with_other_programs.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="interfacing-with-other-programs">
<h1>Interfacing with other programs<a class="headerlink" href="#interfacing-with-other-programs" title="Permalink to this headline"></a></h1>
<p>Horace is designed to be able to call other programs to calculate models for simulating and fitting data.</p>
<p>This document describes two interfaces with other <a class="reference external" href="https://www.isis.stfc.ac.uk/Pages/Proper-analysis-of-coherent-excitations.aspx">PACE</a> projects:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://euphonic.readthedocs.io/">Euphonic</a></p></li>
<li><p><a class="reference external" href="https://spinw.org/">SpinW</a></p></li>
</ul>
<p>as well as a generic way of interfacing with modelling codes you may want to use with Horace.</p>
<p>We also note that the <a class="reference external" href="https://brille.github.io">Brille library</a> for <span class="math notranslate nohighlight">\(q\)</span>-space interpolation
is also a PACE project and is used internally by Euphonic and SpinW to speed up calculations.
Documentation for how to accomplish may be found in the relevant Euphonic and SpinW documentation.</p>
<div class="contents local topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#recap-on-evaluating-functions-on-a-horace-workspace" id="id3">Recap on evaluating functions on a Horace workspace</a></p></li>
<li><p><a class="reference internal" href="#energy-convolution" id="id4">Energy convolution</a></p></li>
<li><p><a class="reference internal" href="#euphonic-example" id="id5">Euphonic example</a></p>
<ul>
<li><p><a class="reference internal" href="#installing-euphonic" id="id6">Installing Euphonic</a></p></li>
<li><p><a class="reference internal" href="#running-a-euphonic-calculation-with-horace" id="id7">Running a Euphonic calculation with Horace</a></p></li>
<li><p><a class="reference internal" href="#fitting-data-with-euphonic-and-horace" id="id8">Fitting data with Euphonic and Horace</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#spinw-example" id="id9">SpinW example</a></p>
<ul>
<li><p><a class="reference internal" href="#installing-spinw" id="id10">Installing SpinW</a></p></li>
<li><p><a class="reference internal" href="#running-a-spinw-calculation-with-horace" id="id11">Running a SpinW calculation with Horace</a></p></li>
<li><p><a class="reference internal" href="#worked-example-with-resolution-convolution" id="id12">Worked example with resolution convolution</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#generic-interface" id="id13">Generic interface</a></p>
<ul>
<li><p><a class="reference internal" href="#matlab-function" id="id14">Matlab function</a></p></li>
<li><p><a class="reference internal" href="#python-function" id="id15">Python function</a></p></li>
<li><p><a class="reference internal" href="#c-c-fortran-function" id="id16">C / C++ / Fortran function</a></p>
<ul>
<li><p><a class="reference internal" href="#prerequisites" id="id17">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#c-example" id="id18">C example</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id19">C++ example</a></p></li>
<li><p><a class="reference internal" href="#fortran-example" id="id20">Fortran example</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="recap-on-evaluating-functions-on-a-horace-workspace">
<h2><a class="toc-backref" href="#id3">Recap on evaluating functions on a Horace workspace</a><a class="headerlink" href="#recap-on-evaluating-functions-on-a-horace-workspace" title="Permalink to this headline"></a></h2>
<p>As described in the <a class="reference internal" href="Getting_started.html#simulations"><span class="std std-ref">Simulation section</span></a>,
Horace takes two types of model functions:</p>
<ul class="simple">
<li><p>User model functions which operate on the <span class="math notranslate nohighlight">\((x,y,z,e)\)</span> coordinates of a particular cut,
evaluated using <a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.func_eval" title="sqw.&#64;SQWDnDBase.func_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">func_eval</span></code></a> and similar functions.</p></li>
<li><p>User model functions which operate on the <span class="math notranslate nohighlight">\((\mathbf{Q}, \omega)\)</span> coordinates,
evaluated using <a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.sqw_eval" title="sqw.&#64;SQWDnDBase.sqw_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">sqw_eval</span></code></a> and similar functions.</p></li>
</ul>
<p>In the first case, for example, if the user makes a 1D cut along the <span class="math notranslate nohighlight">\(\mathbf{Q}=(1,1,0)\)</span> direction,
and calls <a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.func_eval" title="sqw.&#64;SQWDnDBase.func_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">func_eval</span></code></a> on this cut, a single vector of the values of
<span class="math notranslate nohighlight">\(\sqrt{Q_h^2 + Q_k^2}\)</span> is passed to the user model function.
On the other hand, if she calls <a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.sqw_eval" title="sqw.&#64;SQWDnDBase.sqw_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">sqw_eval</span></code></a> on this cut,
4 vectors, namely <span class="math notranslate nohighlight">\((Q_h, Q_k, Q_l, E)\)</span>, are passed to the user model function.
Generally, “simple” functions such as linear backgrounds or peak functions (Gaussians, Lorentzians, etc),
are used with <a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.func_eval" title="sqw.&#64;SQWDnDBase.func_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">func_eval</span></code></a> whilst more complex models use
<a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.sqw_eval" title="sqw.&#64;SQWDnDBase.sqw_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">sqw_eval</span></code></a>.
In particular the interface with external modelling codes described here exclusively use the second type.</p>
</section>
<section id="energy-convolution">
<h2><a class="toc-backref" href="#id4">Energy convolution</a><a class="headerlink" href="#energy-convolution" title="Permalink to this headline"></a></h2>
<p>The <a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.sqw_eval" title="sqw.&#64;SQWDnDBase.sqw_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">sqw_eval</span></code></a> function expects the user model function to return a single vector
<span class="math notranslate nohighlight">\(S(Q_h, Q_k, Q_l, E)\)</span> of neutron intensity evaluated at the 4 reciprocal space coordinates.
However, in many cases calculations instead return pairs of values <span class="math notranslate nohighlight">\((E, I)\)</span>
of mode energy <span class="math notranslate nohighlight">\(E\)</span> and intensity <span class="math notranslate nohighlight">\(I\)</span> for a particular <span class="math notranslate nohighlight">\(\mathbf{Q}=(Q_h, Q_k, Q_l)\)</span> point.
This is the case for phonon calculations, where at each <span class="math notranslate nohighlight">\(\mathbf{Q}\)</span> point
a dynamical matrix is constructed whose eigenvalues are the mode energies squared
and whose eigenvectors can be used to calculate the dynamical structure factor which is proportional to <span class="math notranslate nohighlight">\(I\)</span>.</p>
<p>In these cases, an energy convolution has to be performed to obtain <span class="math notranslate nohighlight">\(S(Q_h, Q_k, Q_l, E)\)</span>.
This can be done with the <a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.disp2sqw_eval" title="sqw.&#64;SQWDnDBase.disp2sqw_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">disp2sqw_eval</span></code></a> function.
This function passes the needed <span class="math notranslate nohighlight">\((Q_h, Q_k, Q_l)\)</span> to the model function
and performs an energy convolution using either:</p>
<ul class="simple">
<li><p>A fixed width peak function (Gaussian by default)</p></li>
<li><p>Energy-variable width peak function, where the peak width varies with energy transfer</p></li>
<li><p>A custom user defined shape function (for <span class="math notranslate nohighlight">\(\mathbf{Q}\)</span> and <span class="math notranslate nohighlight">\(E\)</span> dependent peak shapes).</p></li>
</ul>
<p>Note that this energy convolution is required for <em>all</em> model functions which yields pairs
(energy <span class="math notranslate nohighlight">\(E\)</span>, intensity <span class="math notranslate nohighlight">\(I\)</span>) from an input set of <span class="math notranslate nohighlight">\(\mathbf{Q}=(Q_h, Q_k, Q_l)\)</span> points.
For calculations which take into account
<a class="reference internal" href="Resolution_convolution.html#resolution-convolution"><span class="std std-ref">the instrument resolution function</span></a>,
this energy convolution can be considered the “intrinsic” (lifetime) energy broadening of the excitation.</p>
</section>
<section id="euphonic-example">
<h2><a class="toc-backref" href="#id5">Euphonic example</a><a class="headerlink" href="#euphonic-example" title="Permalink to this headline"></a></h2>
<section id="installing-euphonic">
<span id="install-addons"></span><h3><a class="toc-backref" href="#id6">Installing Euphonic</a><a class="headerlink" href="#installing-euphonic" title="Permalink to this headline"></a></h3>
<p><a class="reference external" href="https://euphonic.readthedocs.io/">Euphonic</a> is a Python package to calculate phonon
inelastic neutron scattering (INS) intensities from force constants determined from <em>ab initio</em> calculations.
To use it with Horace, you should first download the
<a class="reference external" href="https://horace-euphonic-interface.readthedocs.io/en/latest/">Horace-Euphonic-Interface</a>
which is available as a Matlab toolbox add-on.
This can be installed within Matlab by clicking on the “Home” tab in the control ribbon,
then clicking “Add-Ons” and “Get Add-Ons”:</p>
<a class="reference internal image-reference" href="../_images/get_h-eu_interface_01.png"><img alt="Accessing the Add-Ons menu in Matlab" src="../_images/get_h-eu_interface_01.png" style="width: 300px;" /></a>
<p>Type <code class="docutils literal notranslate"><span class="pre">euphonic</span></code> in the search bar, and click on the <code class="docutils literal notranslate"><span class="pre">horace-euphonic-interface</span></code> package.</p>
<a class="reference internal image-reference" href="../_images/get_h-eu_interface_02.png"><img alt="Installing the Horace-Euphonic-Interface Add-On" src="../_images/get_h-eu_interface_02.png" style="width: 500px;" /></a>
<p>Then click “Add” in the next window (you may have to log into your Mathworks account).</p>
<p>If you prefer, you can download the <cite>Horace-Euphonic-Interface</cite> toolbox directly from
<a class="reference external" href="https://github.com/pace-neutrons/horace-euphonic-interface/releases">here</a>
(download the latest <code class="docutils literal notranslate"><span class="pre">mltbx</span></code> file). Then run:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">matlab.addons.toolbox.installToolbox</span><span class="p">(</span><span class="s">&#39;/path/to/mltbx_file&#39;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Because <cite>Euphonic</cite> is a Python program, you need to have Python setup on your system,
and to tell Matlab about this.
Please see <a class="reference external" href="https://horace-euphonic-interface.readthedocs.io/en/latest/#set-up-python-in-matlab">here</a>
for more detailed information.</p>
<p>If you haven’t installed the <cite>Euphonic</cite> Python package then you can do this within Horace using:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">euphonic</span><span class="p">.</span><span class="n">install_python_modules</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
<p>This may not work for all Python distributions, in which case you should install Euphonic manually.
Euphonic can be installed with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">euphonic</span></code> in the Python command line,
but there are also other ways of installing Euphonic, which are detailed in the
<a class="reference external" href="https://euphonic.readthedocs.io/en/stable/installation.html">Euphonic installation instructions</a>.</p>
<p>On the <a class="reference external" href="https://isis.analysis.stfc.ac.uk/">IDAaaS system</a>, you can access the pre-installed
Euphonic Python environment using:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">pyenv</span><span class="p">(</span><span class="s">&#39;Version&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;/usr/local/virtualenvs/euphonicenv/bin/python3&#39;</span><span class="p">);</span><span class="w"></span>
<span class="n">py</span><span class="p">.</span><span class="n">sys</span><span class="p">.</span><span class="n">setdlopenflags</span><span class="p">(</span><span class="nb">int32</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
<p>Note that this should be done at the start of a Matlab session.
If a different Python interpreter has already been started you will need to restart Matlab,
otherwise the above command will give an error.</p>
<p>To test that <cite>Euphonic</cite> has been installed correctly, run:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">help</span><span class="p">(</span><span class="n">euphonic</span><span class="p">.</span><span class="n">ForceConstants</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Which will give you the (Python) help text on the <a class="reference external" href="https://euphonic.readthedocs.io/en/stable/force-constants.html#euphonic.force_constants.ForceConstants" title="(in Euphonic)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForceConstants</span></code></a> class.
If <cite>Euphonic</cite> was not installed correctly, this command will give an error.</p>
</section>
<section id="running-a-euphonic-calculation-with-horace">
<h3><a class="toc-backref" href="#id7">Running a Euphonic calculation with Horace</a><a class="headerlink" href="#running-a-euphonic-calculation-with-horace" title="Permalink to this headline"></a></h3>
<p>To perform a phonon INS calculation Euphonic requires the force constants from an <em>ab initio</em> calculation.
Euphonic can read this information from either a <a class="reference external" href="http://www.castep.org/">CASTEP</a> <code class="docutils literal notranslate"><span class="pre">.castep_bin</span></code> file
using the <a class="reference external" href="https://euphonic.readthedocs.io/en/stable/force-constants.html#euphonic.force_constants.ForceConstants.from_castep" title="(in Euphonic)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">from_castep()</span></code></a> method,
or a <a class="reference external" href="https://phonopy.github.io/phonopy/">Phonopy</a> output folder containing a <code class="docutils literal notranslate"><span class="pre">phonopy.yaml</span></code> file using the
<a class="reference external" href="https://euphonic.readthedocs.io/en/stable/force-constants.html#euphonic.force_constants.ForceConstants.from_phonopy" title="(in Euphonic)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">from_phonopy()</span></code></a> method.</p>
<p>In addition to reading in the force constants, we must also set certain parameters for the INS calculation.
To do this we create a <code class="xref py py-class docutils literal notranslate"><span class="pre">CoherentCrystal</span></code> object from the
<a class="reference external" href="https://euphonic.readthedocs.io/en/stable/force-constants.html#euphonic.force_constants.ForceConstants" title="(in Euphonic)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForceConstants</span></code></a> data we read in.
This <code class="xref py py-class docutils literal notranslate"><span class="pre">CoherentCrystal</span></code> has a method (function),
<code class="xref py py-meth docutils literal notranslate"><span class="pre">horace_disp()</span></code> which can be passed to the Horace
<a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.disp2sqw_eval" title="sqw.&#64;SQWDnDBase.disp2sqw_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">disp2sqw_eval</span></code></a> function.</p>
<p>The following code reads the force constants from a CASTEP file, sets up the
<code class="xref py py-class docutils literal notranslate"><span class="pre">CoherentCrystal</span></code> object and then evaluate the phonon model on an experimental cut:</p>
<div class="highlight-matlab notranslate" id="sim-euphonic"><div class="highlight"><pre><span></span><span class="c">% Read force constants</span><span class="w"></span>
<span class="n">fc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">euphonic</span><span class="p">.</span><span class="n">ForceConstants</span><span class="p">.</span><span class="n">from_castep</span><span class="p">(</span><span class="s">&#39;quartz.castep_bin&#39;</span><span class="p">)</span><span class="w"></span>

<span class="c">% Set up model</span><span class="w"></span>
<span class="n">coh_model</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">euphonic</span><span class="p">.</span><span class="n">CoherentCrystal</span><span class="p">(</span><span class="k">...</span><span class="w"></span>
<span class="w">   </span><span class="n">fc</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">   </span><span class="s">&#39;conversion_mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="s">1</span><span class="w"> </span><span class="s">0</span><span class="p">;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="s">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">   </span><span class="s">&#39;debye_waller_grid&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">6</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">   </span><span class="s">&#39;temperature&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">   </span><span class="s">&#39;asr&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;reciprocal&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">   </span><span class="s">&#39;use_c&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>

<span class="c">% Read in experimental cut</span><span class="w"></span>
<span class="n">cut</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cut_sqw</span><span class="p">(</span><span class="s">&#39;quartz_cut.sqw&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">3.02</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">2.98</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">38</span><span class="p">])</span><span class="w"></span>

<span class="c">% Simulate</span><span class="w"></span>
<span class="n">scale_factor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span><span class="w"></span>
<span class="n">effective_fwhm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">cut_sim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">disp2sqw_eval</span><span class="p">(</span><span class="k">...</span><span class="w"></span>
<span class="w">   </span><span class="n">cut</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="n">coh_model</span><span class="p">.</span><span class="n">horace_disp</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">scale_factor</span><span class="p">},</span><span class="w"> </span><span class="n">effective_fwhm</span><span class="p">);</span><span class="w"></span>

<span class="c">% Plot</span><span class="w"></span>
<span class="nb">plot</span><span class="p">(</span><span class="n">cut_sim</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The data files <code class="docutils literal notranslate"><span class="pre">quartz.castep_bin</span></code> and <code class="docutils literal notranslate"><span class="pre">quartz_cut.sqw</span></code> are available for download
<a class="reference external" href="https://github.com/pace-neutrons/pace-python-demo/blob/main/datafiles/">here</a></p>
</div>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">conversion_mat</span></code> parameter denotes a <span class="math notranslate nohighlight">\(3 \times 3\)</span> matrix to transform from the <span class="math notranslate nohighlight">\(q\)</span>-points
in Horace to that used by the phonon model (i.e. that used in the <em>ab initio</em> calculation).
This is needed if, for example, a primitive unit cell is used in the <em>ab initio</em> calculation
but the Horace data is defined using a conventional unit cell.
By default it is set to the identity matrix.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">debye_waller_grid</span></code> parameter is the size of the (Monhkhorst-Pack) <span class="math notranslate nohighlight">\(q\)</span>-space grid
to use for the Brillouin zone integration needed to calculate the Debye-Waller factor.
Higher values will yield a more accurate calculation but the <span class="math notranslate nohighlight">\(6 \times 6 \times 6\)</span> is sufficient in most cases.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">temperature</span></code> is in Kelvin.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">asr</span></code> parameter specifies whether and how the <em>acoustic sum rule</em> (ASR) correction should be applied:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reciprocal</span></code> applies the ASR correction to the dynamical matrix at every <span class="math notranslate nohighlight">\(q\)</span>-point (recommended).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">realspace</span></code> applies the ASR correction is applied to the force constant matrix in real space.
This method is known to fail for polar systems.</p></li>
</ul>
<p>If this parameter is not specified, the ASR correction is not applied.
This means that the phonon modes are not enforced to have zero energy at the <span class="math notranslate nohighlight">\(\Gamma\)</span> point,
and the dispersion close to <span class="math notranslate nohighlight">\(\Gamma\)</span> may not be linear.
It’s generally best to specify it in the <code class="docutils literal notranslate"><span class="pre">reciprocal</span></code> mode.</p>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">use_c</span></code> parameter specifies whether to use the compiled C extension module for faster calculation or not.</p></li>
</ul>
<p>For further information and other options, type <cite>help(euphonic.CoherentCrystal)</cite> in the Matlab command window.</p>
</section>
<section id="fitting-data-with-euphonic-and-horace">
<h3><a class="toc-backref" href="#id8">Fitting data with Euphonic and Horace</a><a class="headerlink" href="#fitting-data-with-euphonic-and-horace" title="Permalink to this headline"></a></h3>
<p>Fitting in Horace uses the <a class="reference internal" href="../manual/Multifit.html#multifit"><span class="std std-ref">multifit application</span></a>.
After running the <a class="reference internal" href="#sim-euphonic"><span class="std std-ref">above code</span></a>, a fit can be performed using:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit_sqw</span><span class="p">(</span><span class="n">cut</span><span class="p">);</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="p">(@</span><span class="n">disp2sqw</span><span class="p">,</span><span class="w"> </span><span class="p">{@</span><span class="n">coh_model</span><span class="p">.</span><span class="n">horace_disp</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">scale_factor</span><span class="p">},</span><span class="w"> </span><span class="n">effective_fwhm</span><span class="p">});</span><span class="w"></span>
<span class="p">[</span><span class="n">fitted_cut</span><span class="p">,</span><span class="w"> </span><span class="n">fit_pars</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">fit</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>Because <cite>Euphonic</cite> uses <em>ab initio</em> data, the only “fittable” parameters are scale factors.
By default, only the intensity scale factor is fitted to the data.
If you wish, you can also fit an overall energy scale factor, by giving an extra value in the input cell:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="p">(@</span><span class="n">disp2sqw</span><span class="p">,</span><span class="w"> </span><span class="p">{@</span><span class="n">coh_model</span><span class="p">.</span><span class="n">horace_disp</span><span class="p">,</span><span class="w"> </span><span class="p">{[</span><span class="n">scale_factor</span><span class="w"> </span><span class="n">energy_scale</span><span class="p">]},</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">                </span><span class="n">effective_fwhm</span><span class="p">});</span><span class="w"></span>
</pre></div>
</div>
<p>This syntax is also ideally suited to simulating a phonon model with instrument resolution
convolution as described in <a class="reference internal" href="Resolution_convolution.html#resolution-convolution"><span class="std std-ref">the last section</span></a>:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Defines the sample geometry.</span><span class="w"></span>
<span class="n">is_crystal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="n">xgeom</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="n">ygeom</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="n">shape</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;cuboid&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">shape_pars</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.01</span><span class="p">];</span><span class="w"></span>

<span class="c">% Need to set the sample information inside the cut.</span><span class="w"></span>
<span class="n">cut</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">set_sample</span><span class="p">(</span><span class="n">cut</span><span class="p">,</span><span class="w"> </span><span class="n">IX_sample</span><span class="p">(</span><span class="n">is_crystal</span><span class="p">,</span><span class="w"> </span><span class="n">xgeom</span><span class="p">,</span><span class="w"> </span><span class="n">ygeom</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="p">,</span><span class="w"> </span><span class="n">shape_pars</span><span class="p">));</span><span class="w"></span>

<span class="c">% Do the same for the instrument information</span><span class="w"></span>
<span class="n">ei</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w"> </span><span class="n">freq</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">400</span><span class="p">;</span><span class="w"> </span><span class="n">chopper</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;g&#39;</span><span class="p">;</span><span class="w"></span>
<span class="n">cut</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">set_instrument</span><span class="p">(</span><span class="n">cut</span><span class="p">,</span><span class="w"> </span><span class="n">merlin_instrument</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span><span class="w"> </span><span class="n">freq</span><span class="p">,</span><span class="w"> </span><span class="n">chopper</span><span class="p">));</span><span class="w"></span>

<span class="n">scalefac</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1e12</span><span class="p">;</span><span class="w"></span>
<span class="n">intrinsic_fwhm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w"></span>
<span class="n">tt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">  </span><span class="c">% temperature in K</span><span class="w"></span>

<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tobyfit</span><span class="p">(</span><span class="n">cut</span><span class="p">);</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="p">(@</span><span class="n">disp2sqw</span><span class="p">,</span><span class="w"> </span><span class="p">{@</span><span class="n">coh_model</span><span class="p">.</span><span class="n">horace_disp</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">scale_factor</span><span class="p">},</span><span class="w"> </span><span class="n">intrinsic_fwhm</span><span class="p">});</span><span class="w"></span>
<span class="n">sim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">simulate</span><span class="p">(</span><span class="s">&#39;fore&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c">% Plots the data (black points), non-resolution convoluted simulation (black lines)</span><span class="w"></span>
<span class="c">% and resolution-convoluted simulation (red lines)</span><span class="w"></span>
<span class="n">acolor</span><span class="w"> </span><span class="s">black</span><span class="p">;</span><span class="w"> </span><span class="nb">plot</span><span class="p">(</span><span class="n">cut</span><span class="p">);</span><span class="w"> </span><span class="n">pl</span><span class="p">(</span><span class="n">cut_sim</span><span class="p">);</span><span class="w"> </span><span class="n">acolor</span><span class="w"> </span><span class="s">red</span><span class="p">;</span><span class="w"> </span><span class="n">pl</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>In this case, the energy width parameter is an <em>intrinsic</em> (lifetime) width instead of
an effective width which includes contribution from both instrument resolution as well as lifetime broadening.</p>
<a class="reference internal image-reference" href="../_images/quartz_cut.png"><img alt="Cut showing quartz data and simulation with (red) and without (black) resolution convolution." src="../_images/quartz_cut.png" style="width: 500px;" /></a>
</section>
</section>
<section id="spinw-example">
<h2><a class="toc-backref" href="#id9">SpinW example</a><a class="headerlink" href="#spinw-example" title="Permalink to this headline"></a></h2>
<section id="installing-spinw">
<h3><a class="toc-backref" href="#id10">Installing SpinW</a><a class="headerlink" href="#installing-spinw" title="Permalink to this headline"></a></h3>
<p><a class="reference external" href="https://spinw.org/">SpinW</a> is a Matlab program to calculate magnetic inelastic neutron spectra
using linear spin wave theory (LSWT).
It is available as an “Add-On”, and can be installed similarly to the
<a class="reference internal" href="#install-addons"><span class="std std-ref">Horace-Euphonic-Interface</span></a> above (search for <code class="docutils literal notranslate"><span class="pre">spinw</span></code> instead of <code class="docutils literal notranslate"><span class="pre">euphonic</span></code>!).</p>
<p>Alternatively, you can download the <a class="reference external" href="https://github.com/SpinW/spinw/releases/latest">zipped release distribution</a>
and extract it to a folder and then add that folder to the Matlab path using <code class="docutils literal notranslate"><span class="pre">addpath(genpath('/path/to/spinw'))</span></code>.</p>
</section>
<section id="running-a-spinw-calculation-with-horace">
<h3><a class="toc-backref" href="#id11">Running a SpinW calculation with Horace</a><a class="headerlink" href="#running-a-spinw-calculation-with-horace" title="Permalink to this headline"></a></h3>
<p>Similarly to the Euphonic <code class="xref py py-meth docutils literal notranslate"><span class="pre">horace_disp()</span></code> method,
the <a class="reference external" href="https://spinw.org/spinw">spinw class</a> has a <code class="docutils literal notranslate"><span class="pre">horace_sqw</span></code> method
which is used as a gateway between SpinW and Horace.</p>
<p><code class="docutils literal notranslate"><span class="pre">horace_sqw</span></code> acts as a wrapper around the <code class="docutils literal notranslate"><span class="pre">spinwave</span></code> and <code class="docutils literal notranslate"><span class="pre">sw_neutron</span></code> functions
which carry out the actual spin wave INS calculations in SpinW.
In addition, it also carries out the energy convolution described in the <a class="reference internal" href="#energy-convolution">Energy convolution</a> section above.</p>
<p>A user should set up a SpinW model and then pass a handle (indicated by the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> operator)
to the <code class="docutils literal notranslate"><span class="pre">horace_sqw</span></code> method to <a class="reference internal" href="../API_Reference.html#sqw.&#64;SQWDnDBase.sqw_eval" title="sqw.&#64;SQWDnDBase.sqw_eval"><code class="xref mat mat-mod docutils literal notranslate"><span class="pre">sqw_eval</span></code></a>
or directly to a <a class="reference internal" href="../manual/Multifit.html#multifit"><span class="std std-ref">multifit object</span></a>, for example:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Set up a simple triangular lattice antiferromagnet model</span><span class="w"></span>
<span class="n">J</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1.2</span><span class="p">;</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">;</span><span class="w"> </span><span class="n">fwhm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.75</span><span class="p">;</span><span class="w"> </span><span class="n">scalefactor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">tri</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sw_model</span><span class="p">(</span><span class="s">&#39;triAF&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">J</span><span class="p">);</span><span class="w"></span>
<span class="n">tri</span><span class="p">.</span><span class="n">addmatrix</span><span class="p">(</span><span class="s">&#39;label&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;K&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;value&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">diag</span><span class="p">([</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">K</span><span class="p">]));</span><span class="w"> </span><span class="n">tri</span><span class="p">.</span><span class="n">addaniso</span><span class="p">(</span><span class="s">&#39;K&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c">% Make a cut of some data</span><span class="w"></span>
<span class="n">ws</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cut_sqw</span><span class="p">(</span><span class="n">sqw_file</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.05</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">0.5</span><span class="p">]);</span><span class="w"></span>

<span class="c">% Set up the fitting problem</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit_sqw</span><span class="p">(</span><span class="n">ws</span><span class="p">);</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="p">(@</span><span class="n">tri</span><span class="p">.</span><span class="n">horace_sqw</span><span class="p">);</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_pin</span><span class="p">({[</span><span class="n">J</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="n">fwhm</span><span class="w"> </span><span class="n">scalefactor</span><span class="p">],</span><span class="w"> </span><span class="s">&#39;mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;J_1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;K(3,3)&#39;</span><span class="p">},</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">                </span><span class="s">&#39;hermit&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;formfact&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;usefast&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s">&#39;resfun&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;gauss&#39;</span><span class="p">});</span><span class="w"></span>

<span class="c">% Run a simulation and then a fit</span><span class="w"></span>
<span class="n">ws_sim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">simulate</span><span class="p">();</span><span class="w"></span>
<span class="p">[</span><span class="n">ws_fit</span><span class="p">,</span><span class="w"> </span><span class="n">fit_dat</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">fit</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
<p>Let’s concentrate on the line where the input parameters and arguments are set:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_pin</span><span class="p">({[</span><span class="n">J</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="n">fwhm</span><span class="w"> </span><span class="n">scalefactor</span><span class="p">],</span><span class="w"> </span><span class="s">&#39;mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;J_1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;K(3,3)&#39;</span><span class="p">},</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">                </span><span class="s">&#39;hermit&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;formfact&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;usefast&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">});</span><span class="w"></span>
</pre></div>
</div>
<p>The convention in Horace is that if the parameters are given as a cell array,
then the first element <em>must</em> be a vector of fit parameters,
whilst everything else is passed unchanged to the model function (<code class="docutils literal notranslate"><span class="pre">horace_sqw</span></code> in this case).
Thus, in this case we see that the fit parameters are <code class="docutils literal notranslate"><span class="pre">[J</span> <span class="pre">K</span> <span class="pre">fwhm</span> <span class="pre">scalefactor]</span></code>.
The first two (<code class="docutils literal notranslate"><span class="pre">J</span></code> and <code class="docutils literal notranslate"><span class="pre">K</span></code>) are defined by the spinwave model
whilst the last two (<code class="docutils literal notranslate"><span class="pre">fwhm</span></code> and <code class="docutils literal notranslate"><span class="pre">scalefactor</span></code>) are defined by <code class="docutils literal notranslate"><span class="pre">horace_sqw</span></code>’s energy convolution routines.
By default, a fixed width convolution with a Gaussian is performed,
but <code class="docutils literal notranslate"><span class="pre">horace_sqw</span></code> takes an argument <code class="docutils literal notranslate"><span class="pre">resfun</span></code> which can be used to specify a different peak function:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'resfun',</span> <span class="pre">'gauss'</span></code> - a Gaussian peak (two parameter: <code class="docutils literal notranslate"><span class="pre">fwhm</span></code> and <code class="docutils literal notranslate"><span class="pre">scalefactor</span></code>) [default]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'resfun',</span> <span class="pre">'lor'</span></code> - a Lorentzian peak (two parameter: <code class="docutils literal notranslate"><span class="pre">fwhm</span></code> and <code class="docutils literal notranslate"><span class="pre">scalefactor</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'resfun',</span> <span class="pre">'voigt'</span></code> - a pseudo-Voigt peak (3 parameters: <code class="docutils literal notranslate"><span class="pre">fwhm</span></code>, <code class="docutils literal notranslate"><span class="pre">lorentzian_fraction</span></code> and <code class="docutils literal notranslate"><span class="pre">scalefactor</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'resfun',</span> <span class="pre">'sho'</span></code> - a damped harmonic oscillator (3 parameters: <code class="docutils literal notranslate"><span class="pre">Gamma</span></code>, <code class="docutils literal notranslate"><span class="pre">Temperature</span></code> and <code class="docutils literal notranslate"><span class="pre">Amplitude</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'resfun',</span> <span class="pre">&#64;fun_handle</span></code> - a function handle to a function which will be accepted by Horace’s <code class="docutils literal notranslate"><span class="pre">disp2sqw</span></code> method</p></li>
</ul>
<p>Note that the different options to <code class="docutils literal notranslate"><span class="pre">resfun</span></code> changes the number of parameters which should be set by Horace.
For example, if there are <span class="math notranslate nohighlight">\(n\)</span> spinwave model parameters and the user specifies the <code class="docutils literal notranslate"><span class="pre">sho</span></code> peak function,
they should pass <span class="math notranslate nohighlight">\(n+3\)</span> parameters (intrinsic width <span class="math notranslate nohighlight">\(\Gamma\)</span>, sample temperature and an intensity amplitude)</p>
<p>A SpinW model can contain a lot of parameters
and furthermore defines the exchange and anisotropy in terms of <span class="math notranslate nohighlight">\(3 \times 3\)</span> tensors,
whilst Horace accepts only scalar parameters.
In order to specify which SpinW model parameters should be fitted by Horace,
users should use the <code class="docutils literal notranslate"><span class="pre">mat</span></code> and <code class="docutils literal notranslate"><span class="pre">selector</span></code> arguments. If there are <span class="math notranslate nohighlight">\(n\)</span> parameters to be fitted then:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mat</span></code> is an <span class="math notranslate nohighlight">\(n\)</span>-element cell array of the matrix names defined in the SpinW model,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">selector</span></code> is a <span class="math notranslate nohighlight">\(3 \times 3 \times n\)</span> array of logical indices indicating which element of the named matrix should be fitted.</p></li>
</ul>
<p>For simple cases where only one scalar value of each named matrix should be fitted then <code class="docutils literal notranslate"><span class="pre">selector</span></code> is not needed.
This is the case for Heisenberg interactions and simple single-ion anisotropy along one of the <span class="math notranslate nohighlight">\(xyz\)</span> axes defined by the SpinW model.
That was the case above where <code class="docutils literal notranslate"><span class="pre">'mat',</span> <span class="pre">{'J_1',</span> <span class="pre">'K(3,3)'}</span></code> indicates that:</p>
<ul class="simple">
<li><p>The first Horace-fittable parameter <code class="docutils literal notranslate"><span class="pre">p(1)</span></code> corresponds to the <code class="docutils literal notranslate"><span class="pre">J_1</span></code> named matrix and that matrix should be set to <code class="docutils literal notranslate"><span class="pre">eye(3)*p(1)</span></code>.</p></li>
<li><p>The second Horace-fittable parameter <code class="docutils literal notranslate"><span class="pre">p(2)</span></code> corresponds to the <code class="docutils literal notranslate"><span class="pre">K</span></code> named matrix and that one the matrix element should be set as <code class="docutils literal notranslate"><span class="pre">K(3,3)=p(2)</span></code>.</p></li>
</ul>
<p>For example, if the user wants both an anisotropy along <span class="math notranslate nohighlight">\(z\)</span> and <span class="math notranslate nohighlight">\(x\)</span> which can vary independently,
they can set <code class="docutils literal notranslate"><span class="pre">'mat',</span> <span class="pre">{'K(1,1)',</span> <span class="pre">'K(3,3)'}</span></code>.</p>
<p>In more complex cases, for example for a DM interaction where multiple elements of a named matrix are dependent,
the <code class="docutils literal notranslate"><span class="pre">selector</span></code> argument should be given:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">vec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.1</span><span class="w"> </span><span class="mf">0.2</span><span class="w"> </span><span class="mf">0.3</span><span class="p">];</span><span class="w"></span>
<span class="n">swobj</span><span class="p">.</span><span class="n">addmatrix</span><span class="p">(</span><span class="s">&#39;label&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;DM&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;value&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">Dvec</span><span class="p">);</span><span class="w"></span>
<span class="n">swobj</span><span class="p">.</span><span class="n">addcoupling</span><span class="p">(</span><span class="s">&#39;mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;DM&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;bond&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="n">sel</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="s">0</span><span class="w"> </span><span class="s">1</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span><span class="w">    </span><span class="c">% Dx</span><span class="w"></span>
<span class="n">sel</span><span class="p">(:,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="s">0</span><span class="w"> </span><span class="s">0</span><span class="p">;</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span><span class="w">    </span><span class="c">% Dy</span><span class="w"></span>
<span class="n">sel</span><span class="p">(:,:,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="s">0</span><span class="w"> </span><span class="s">0]</span><span class="p">;</span><span class="w">    </span><span class="c">% Dz</span><span class="w"></span>

<span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="p">(@</span><span class="n">swobj</span><span class="p">.</span><span class="n">horace_sqw</span><span class="p">);</span><span class="w"></span>
<span class="n">kk</span><span class="p">.</span><span class="n">set_pin</span><span class="p">({</span><span class="n">Dvec</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;DM&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;DM&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;DM&#39;</span><span class="p">},</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">    </span><span class="s">&#39;selector&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">sel</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;hermit&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">})</span><span class="w"></span>
<span class="n">kk</span><span class="p">.</span><span class="n">fit</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
<p>In this example, the 3 parameters to be varied by Horace are the elements of the DM vector
in the Cartesian <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, <span class="math notranslate nohighlight">\(z\)</span>, directions defined by the SpinW model.
In each case, two elements of the <code class="docutils literal notranslate"><span class="pre">DM</span></code> matrix should be varied together, which is indicated by the <code class="docutils literal notranslate"><span class="pre">sel</span></code> array.</p>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">mat</span></code> and <code class="docutils literal notranslate"><span class="pre">selector</span></code>, <code class="docutils literal notranslate"><span class="pre">horace_sqw</span></code> also takes some other arguments:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">'usefast'</span></code> - This tells <code class="docutils literal notranslate"><span class="pre">horace_sqw</span></code> to use a faster but slightly less accurate code than <code class="docutils literal notranslate"><span class="pre">spinwave</span></code>. In particular, this code achieves a speed gain by:</p>
<blockquote>
<div><ul class="simple">
<li><p>Only calculating <code class="docutils literal notranslate"><span class="pre">Sperp</span></code> rather than the full <span class="math notranslate nohighlight">\(S^{\alpha\beta}\)</span> tensor</p></li>
<li><p>Only calculating magnon creation (positive energy / neutron energy loss) modes.</p></li>
<li><p>Ignoring twins</p></li>
</ul>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">'coordtrans'</span></code> - A <span class="math notranslate nohighlight">\(4 \times 4\)</span> matrix to transform the input <span class="math notranslate nohighlight">\((Q_h,Q_k,Q_l,\hbar\omega)\)</span> coordinates received from Horace before passing to SpinW</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">usefast</span></code> option may not work correctly for models which defines an incommensurate magnetic structure.
We recommend checking the calculations with <code class="docutils literal notranslate"><span class="pre">'usefast',</span> <span class="pre">false</span></code> before using it in production.</p>
</div>
<p>Finally, any argument used by the <a class="reference external" href="https://spinw.org/spinw_spinwave">spinwave method</a>,
such as <code class="docutils literal notranslate"><span class="pre">'hermit',</span> <span class="pre">false</span></code> can be passed in the parameters cell array.
More information is available in the online help: type <code class="docutils literal notranslate"><span class="pre">doc</span> <span class="pre">spinw/horace_sqw</span></code> in Matlab.</p>
</section>
<section id="worked-example-with-resolution-convolution">
<h3><a class="toc-backref" href="#id12">Worked example with resolution convolution</a><a class="headerlink" href="#worked-example-with-resolution-convolution" title="Permalink to this headline"></a></h3>
<p>The code below is a fully working script for the material, <span class="math notranslate nohighlight">\(\mathrm{Pr(Ca, Sr)_2Mn_2O_7}\)</span>,
which is a half-doped bilayer manganite with an intriguing magnetic ground state.
This was the subject of differing models of the exchange interactions deduced from diffraction data
and was eventually resolved by inelastic neutron measurements.
For details, please see <a class="reference external" href="https://doi.org/10.1103/PhysRevLett.109.237202">G.E. Johnstone et al.</a>
and <a class="reference external" href="https://doi.org/10.1103/PhysRevB.94.014405">Ewings et al.</a>.</p>
<p>The following code simulates a 2D slice with resolution convolution using the parameters found by <cite>Johnstone et al.</cite>
The <cite>SpinW</cite> model can be downloaded <a class="reference external" href="https://spinw.org/RealWorldExample/matlab/prcasrmn2o7.m">here</a>
and the data file is <a class="reference external" href="https://github.com/pace-neutrons/pace-python-demo/blob/main/datafiles/pcsmo_cut1.sqw">here</a>.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Create a cut of the data</span><span class="w"></span>
<span class="n">proj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">projaxes</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rrr&#39;</span><span class="p">)</span><span class="w"></span>
<span class="n">w1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cut_sqw</span><span class="p">(</span><span class="s">&#39;pcsmo_cut1.sqw&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">proj</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">])</span><span class="w"></span>

<span class="c">% Defines the sample and instrument parameters</span><span class="w"></span>
<span class="n">sample</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">IX_sample</span><span class="p">(</span><span class="nb">true</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;cuboid&#39;</span><span class="p">,[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.01</span><span class="p">]);</span><span class="w"></span>
<span class="n">maps</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">maps_instrument</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;S&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c">% Defines the spin wave model</span><span class="w"></span>
<span class="n">JF1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mf">11.39</span><span class="p">;</span><span class="w"> </span><span class="n">JA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span><span class="w"> </span><span class="n">JF2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.35</span><span class="p">;</span><span class="w"> </span><span class="n">JF3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span><span class="w"> </span><span class="n">Jperp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.88</span><span class="p">;</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.074</span><span class="p">;</span><span class="w"></span>
<span class="n">cpars</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;JF1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;JA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;JF2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;JF3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Jperp&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;D(3,3)&#39;</span><span class="p">},</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">    </span><span class="s">&#39;hermit&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;optmem&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;useFast&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;formfact&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">    </span><span class="s">&#39;resfun&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;gauss&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;coordtrans&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">diag</span><span class="p">([</span><span class="mi">2</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">])};</span><span class="w"></span>

<span class="c">% Define the SpinW model in a separate script file to save space</span><span class="w"></span>
<span class="c">% The script creates a spinw object called `pcsmo`</span><span class="w"></span>
<span class="n">prcasrmn2o7</span><span class="p">;</span><span class="w"></span>

<span class="c">% Adds twin info, also means we can&#39;t use (&#39;usefast&#39;, true)</span><span class="w"></span>
<span class="n">pcsmo</span><span class="p">.</span><span class="n">addtwin</span><span class="p">(</span><span class="s">&#39;axis&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&#39;phid&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span><span class="w"></span>

<span class="c">% Mask 90% (keep 10%) of detector pixels to speed up calculation time</span><span class="w"></span>
<span class="n">w1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mask_random_fraction_pixels</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span><span class="w"></span>

<span class="c">% Set up the resolution convolution calculation</span><span class="w"></span>
<span class="n">w1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">set_sample</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span><span class="w"> </span><span class="n">sample</span><span class="p">);</span><span class="w"></span>
<span class="n">w1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">set_instrument</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span><span class="w"> </span><span class="n">maps</span><span class="p">);</span><span class="w"></span>
<span class="n">tbf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tobyfit</span><span class="p">(</span><span class="n">w1</span><span class="p">);</span><span class="w"></span>
<span class="n">tbf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tbf</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">pcsmo</span><span class="p">.</span><span class="n">horace_sqw</span><span class="p">,</span><span class="w"> </span><span class="p">{[</span><span class="n">JF1</span><span class="w"> </span><span class="n">JA</span><span class="w"> </span><span class="n">JF2</span><span class="w"> </span><span class="n">JF3</span><span class="w"> </span><span class="n">Jperp</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="mf">0.1</span><span class="p">]</span><span class="w"> </span><span class="n">cpars</span><span class="p">{:}});</span><span class="w"></span>
<span class="n">tbf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tbf</span><span class="p">.</span><span class="n">set_mc_points</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="n">ws_sim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tbf</span><span class="p">.</span><span class="n">simulate</span><span class="p">();</span><span class="w"></span>

<span class="nb">plot</span><span class="p">(</span><span class="n">w1</span><span class="p">);</span><span class="w"> </span><span class="n">keep_figure</span><span class="p">;</span><span class="w"> </span><span class="nb">plot</span><span class="p">(</span><span class="n">ws_sim</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>The calculation takes around 5 minutes (~1h without masking).</p>
<a class="reference internal image-reference" href="../_images/pcsmo_exp.png"><img alt="../_images/pcsmo_exp.png" src="../_images/pcsmo_exp.png" style="width: 49%;" /></a>
<a class="reference internal image-reference" href="../_images/pcsmo_calc.png"><img alt="../_images/pcsmo_calc.png" src="../_images/pcsmo_calc.png" style="width: 49%;" /></a>
<p>Left is the data, right is the calculation with resolution convolution.</p>
</section>
</section>
<section id="generic-interface">
<h2><a class="toc-backref" href="#id13">Generic interface</a><a class="headerlink" href="#generic-interface" title="Permalink to this headline"></a></h2>
<p>As we saw from the examples above, the Horace <a class="reference internal" href="../manual/Multifit.html#multifit"><span class="std std-ref">multifit application</span></a>
expects a model function to have the following signature:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">I</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">user_model</span><span class="p">(</span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">qh</span></code>, <code class="docutils literal notranslate"><span class="pre">qk</span></code>, <code class="docutils literal notranslate"><span class="pre">ql</span></code>, and <code class="docutils literal notranslate"><span class="pre">en</span></code> are <span class="math notranslate nohighlight">\(n_{\mathrm{pix}}\)</span>-length vectors denoting the
coordinates of the pixels of a Horace <code class="docutils literal notranslate"><span class="pre">sqw</span></code> object, or the bin centres of a <code class="docutils literal notranslate"><span class="pre">dnd</span></code> object.
The function should return an <span class="math notranslate nohighlight">\(n_{\mathrm{pix}}\)</span>-length vector <code class="docutils literal notranslate"><span class="pre">I</span></code> of neutron intensities at those coordinates.
<code class="docutils literal notranslate"><span class="pre">parameters</span></code> is a vector of the current iteration’s fittable parameter values, and
<code class="docutils literal notranslate"><span class="pre">varargin</span></code> is an optional cell array denoting a variable-length argument list,
using <a class="reference external" href="https://www.mathworks.com/help/matlab/ref/varargin.html">standard Matlab syntax</a>.</p>
<p>This function is passed to a <code class="docutils literal notranslate"><span class="pre">multifit</span></code> object using the <code class="docutils literal notranslate"><span class="pre">set_fun</span></code> method,
and its initial parameters set using the <code class="docutils literal notranslate"><span class="pre">set_pin</span></code> method:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit</span><span class="p">(</span><span class="n">ws</span><span class="p">);</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="p">(@</span><span class="n">user_model</span><span class="p">);</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_pin</span><span class="p">({</span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">{:}});</span><span class="w"></span>
</pre></div>
</div>
<p>If there are no arguments to be passed (e.g. <code class="docutils literal notranslate"><span class="pre">varargin</span></code> should be empty), then a vector rather
a cell array can be passed to <code class="docutils literal notranslate"><span class="pre">set_pin</span></code>:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_pin</span><span class="p">(</span><span class="n">parameters</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>In the following sections we describe how user defined model functions in several different languages
can be used with the <a class="reference internal" href="../manual/Multifit.html#multifit"><span class="std std-ref">multifit application</span></a> in Horace.
We will use the example of spin waves in bcc-Iron, where the scattering function is given by:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}S(q_h, q_k, q_l, E) &amp;= \frac{I_0}{\pi} \frac{4\Gamma E_0}{(E^2 - E_0^2)^2 - 4(\Gamma E)^2} \mathcal{N} \mathcal{F}\\\begin{split}\\\end{split}\\E_0(q_h, q_k, q_l, E) &amp;= \Delta + 8 J \left(1 - \cos(\pi q_h) \cos(\pi q_k) \cos(\pi q_l) \right)\\\mathcal{N}(E) &amp;= \frac{E}{1 - \exp \left( - \frac{E}{k_B T} \right)}\\\mathcal{F}(q) &amp;= A \exp(-a q^2) + B \exp(-b q^2) + C \exp(-c q^2) + D\end{aligned}\end{align} \]</div>
<p>where <span class="math notranslate nohighlight">\(I_0\)</span> is an amplitude (intensity scaling) parameter,
<span class="math notranslate nohighlight">\(\Gamma\)</span> is an energy width parameter, <span class="math notranslate nohighlight">\(\Delta\)</span> is an energy gap parameter,
and <span class="math notranslate nohighlight">\(J\)</span> is an exchange parameter to be fitted.
Thus <span class="math notranslate nohighlight">\(E_0(E)\)</span> is the <em>dispersion relation</em>, <span class="math notranslate nohighlight">\(\mathcal{N}_(T)\)</span> is the thermal population (Bose) factor
where <span class="math notranslate nohighlight">\(k_B\)</span> is Boltzmann’s constant and <span class="math notranslate nohighlight">\(T\)</span> the sample temperature.
<span class="math notranslate nohighlight">\(F(q)\)</span> is the magnetic form factor for metallic iron with <span class="math notranslate nohighlight">\(q = \sqrt{q_h^2 + q_k^2 + q_l^2}/(4a^2)\)</span>,
where <span class="math notranslate nohighlight">\(a=2.87~\text{Å}\)</span> is the lattice parameter of bcc-Iron and the parameters <span class="math notranslate nohighlight">\(A=0.0706\)</span>, <span class="math notranslate nohighlight">\(a=35.008\)</span>,
<span class="math notranslate nohighlight">\(B=0.3589\)</span>, <span class="math notranslate nohighlight">\(b=15.358\)</span>, <span class="math notranslate nohighlight">\(C=0.5819\)</span>, <span class="math notranslate nohighlight">\(c=5.561\)</span>, and <span class="math notranslate nohighlight">\(D=-0.0114\)</span>.</p>
<p>The data file for the code examples below can be downloaded from
<a class="reference external" href="https://github.com/pace-neutrons/pace-python-demo/blob/main/datafiles/fe_cut.sqw">here</a>.</p>
<div class="contents local topic" id="id1">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#matlab-function" id="id21">Matlab function</a></p></li>
<li><p><a class="reference internal" href="#python-function" id="id22">Python function</a></p></li>
<li><p><a class="reference internal" href="#c-c-fortran-function" id="id23">C / C++ / Fortran function</a></p>
<ul>
<li><p><a class="reference internal" href="#prerequisites" id="id24">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#c-example" id="id25">C example</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id26">C++ example</a></p></li>
<li><p><a class="reference internal" href="#fortran-example" id="id27">Fortran example</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="matlab-function">
<h3><a class="toc-backref" href="#id21">Matlab function</a><a class="headerlink" href="#matlab-function" title="Permalink to this headline"></a></h3>
<p>The simplest case is for a model function written in Matlab.
Put the following into a file called <code class="docutils literal notranslate"><span class="pre">fe_sqw.m</span></code>:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>out<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">fe_sqw</span><span class="p">(</span>h, k, l, e, p<span class="p">)</span><span class="w"></span>

<span class="n">js</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="nb">gamma</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="n">I0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="n">temperature</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>

<span class="n">E0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">js</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="nb">pi</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="nb">pi</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="nb">pi</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l</span><span class="p">));</span><span class="w"></span>
<span class="n">q2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.87</span><span class="p">)</span>^<span class="mi">2</span><span class="p">);</span><span class="w"></span>

<span class="c">% The magnetic form factor of iron</span><span class="w"></span>
<span class="n">A</span><span class="p">=</span><span class="mf">0.0706</span><span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="p">=</span><span class="mf">35.008</span><span class="p">;</span><span class="w">  </span><span class="n">B</span><span class="p">=</span><span class="mf">0.3589</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="p">=</span><span class="mf">15.358</span><span class="p">;</span><span class="w">  </span><span class="n">C</span><span class="p">=</span><span class="mf">0.5819</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="p">=</span><span class="mf">5.561</span><span class="p">;</span><span class="w">  </span><span class="n">D</span><span class="p">=</span><span class="o">-</span><span class="mf">0.0114</span><span class="p">;</span><span class="w"></span>
<span class="n">ff</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D</span><span class="p">;</span><span class="w"></span>

<span class="n">out</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">ff</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="p">(</span><span class="n">I0</span><span class="o">/</span><span class="nb">pi</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">11.602</span><span class="o">*</span><span class="n">e</span><span class="o">/</span><span class="n">temperature</span><span class="p">)))</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">      </span><span class="o">.*</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">gamma</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">E0</span><span class="p">)</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="p">((</span><span class="n">e</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">E0</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="nb">gamma</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>For simplicity we have passed the sample temperature as a fit variable but it should be fixed in the fitting:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Make a cut of the data</span><span class="w"></span>
<span class="n">proj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">projaxes</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rrr&#39;</span><span class="p">);</span><span class="w"></span>
<span class="n">w_fe</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cut_sqw</span><span class="p">(</span><span class="s">&#39;fe_cut.sqw&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">proj</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">1.05</span><span class="p">,</span><span class="o">-</span><span class="mf">0.95</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">]);</span><span class="w"></span>

<span class="c">% Define starting parameters</span><span class="w"></span>
<span class="n">J</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">35</span><span class="p">;</span><span class="w">     </span><span class="c">% Exchange interaction in meV</span><span class="w"></span>
<span class="n">D</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">      </span><span class="c">% Single-ion anisotropy in meV</span><span class="w"></span>
<span class="n">gam</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w">   </span><span class="c">% Intrinsic linewidth in meV (inversely proportional to excitation lifetime)</span><span class="w"></span>
<span class="n">temp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">  </span><span class="c">% Sample measurement temperature in Kelvin</span><span class="w"></span>
<span class="n">amp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">300</span><span class="p">;</span><span class="w">  </span><span class="c">% Magnitude of the intensity of the excitation (arbitrary units)</span><span class="w"></span>

<span class="c">% Define the fitting problem</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit_sqw</span><span class="p">(</span><span class="n">w_fe</span><span class="p">)</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">fe_sqw</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">gam</span><span class="p">,</span><span class="w"> </span><span class="n">amp</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">])</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_free</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bfun</span><span class="w"> </span><span class="p">(@</span><span class="n">linear_bg</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bfree</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"></span>

<span class="p">[</span><span class="n">wfit</span><span class="p">,</span><span class="w"> </span><span class="n">fitdata</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">fit</span><span class="p">()</span><span class="w"></span>
<span class="nb">plot</span><span class="p">(</span><span class="n">w_fe</span><span class="p">);</span><span class="w"> </span><span class="n">pl</span><span class="p">(</span><span class="n">wfit</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Note that we have used an alternative syntax for <code class="docutils literal notranslate"><span class="pre">set_fun</span></code> where the initial parameter is also set and then
forced the sample temperature (the 5th parameter) to be fixed during the fitting with <code class="docutils literal notranslate"><span class="pre">kk</span> <span class="pre">=</span> <span class="pre">kk.set_free([1,1,1,1,0])</span></code>.</p>
<p>Alternatively we could have defined the function to take the temperature as an extra argument and only have 4 fittable parameters:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>out<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">fe_sqw</span><span class="p">(</span>h, k, l, e, p, temperature<span class="p">)</span><span class="w"></span>
<span class="n">js</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="nb">gamma</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="n">I0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Then the fitting code would be:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit_sqw</span><span class="p">(</span><span class="n">w_fe</span><span class="p">)</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">fe_sqw</span><span class="p">,</span><span class="w"> </span><span class="p">{[</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">gam</span><span class="p">,</span><span class="w"> </span><span class="n">amp</span><span class="p">]</span><span class="w"> </span><span class="n">temp</span><span class="p">})</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="python-function">
<h3><a class="toc-backref" href="#id22">Python function</a><a class="headerlink" href="#python-function" title="Permalink to this headline"></a></h3>
<p>If your model function is defined in Python, or requires the use of Python modules,
it is still possible to call it in Horace using the
<a class="reference external" href="https://www.mathworks.com/help/matlab/call-python-libraries.html">in-built Python calling facility</a> of Matlab.
This is accessed using the <code class="docutils literal notranslate"><span class="pre">py.</span></code> namespace.</p>
<p>For example, let us define a Python file called <code class="docutils literal notranslate"><span class="pre">fe_module.py</span></code> with the following function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">fe_function</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>
    <span class="n">js</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">d</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">I0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">E0</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">js</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">l</span><span class="p">))</span>
    <span class="n">q2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.87</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># The magnetic form factor of iron</span>
    <span class="n">A</span><span class="o">=</span><span class="mf">0.0706</span><span class="p">;</span> <span class="n">a</span><span class="o">=</span><span class="mf">35.008</span><span class="p">;</span>  <span class="n">B</span><span class="o">=</span><span class="mf">0.3589</span><span class="p">;</span> <span class="n">b</span><span class="o">=</span><span class="mf">15.358</span><span class="p">;</span>  <span class="n">C</span><span class="o">=</span><span class="mf">0.5819</span><span class="p">;</span> <span class="n">c</span><span class="o">=</span><span class="mf">5.561</span><span class="p">;</span>  <span class="n">D</span><span class="o">=-</span><span class="mf">0.0114</span><span class="p">;</span>
    <span class="n">ff</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">q2</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">q2</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">q2</span><span class="p">)</span> <span class="o">+</span> <span class="n">D</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">I0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">11.602</span><span class="o">*</span><span class="n">e</span><span class="o">/</span><span class="n">temperature</span><span class="p">)))</span> \
           <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">E0</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">E0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Because <a class="reference internal" href="../manual/Multifit.html#multifit"><span class="std std-ref">multifit</span></a> expects a <em>Matlab</em> function handle,
we must now wrap this Python function in a Matlab <em>anonymous function</em> (equivalent to a Python <em>lambda</em> function):</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">fe_sqw_py</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">temperature</span><span class="p">)</span><span class="w"> </span><span class="nb">double</span><span class="p">(</span><span class="n">py</span><span class="p">.</span><span class="n">fe_module</span><span class="p">.</span><span class="n">fe_function</span><span class="p">(</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">             </span><span class="n">py</span><span class="p">.</span><span class="n">numpy</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="w"> </span><span class="n">py</span><span class="p">.</span><span class="n">numpy</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="n">py</span><span class="p">.</span><span class="n">numpy</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">             </span><span class="n">py</span><span class="p">.</span><span class="n">numpy</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">en</span><span class="p">),</span><span class="w"> </span><span class="n">py</span><span class="p">.</span><span class="n">numpy</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span><span class="w"> </span><span class="n">temperature</span><span class="p">);</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit_sqw</span><span class="p">(</span><span class="n">w_fe</span><span class="p">)</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">fe_sqw_py</span><span class="p">,</span><span class="w"> </span><span class="p">{[</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">gam</span><span class="p">,</span><span class="w"> </span><span class="n">amp</span><span class="p">]</span><span class="w"> </span><span class="n">temp</span><span class="p">})</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bfun</span><span class="w"> </span><span class="p">(@</span><span class="n">linear_bg</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bfree</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="p">[</span><span class="n">wfit</span><span class="p">,</span><span class="w"> </span><span class="n">fitdata</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">fit</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="c-c-fortran-function">
<h3><a class="toc-backref" href="#id23">C / C++ / Fortran function</a><a class="headerlink" href="#c-c-fortran-function" title="Permalink to this headline"></a></h3>
<p>Finally, we can also call compiled functions written in C, C++ or Fortran from Matlab
but there are some limitations:</p>
<ul class="simple">
<li><p>We use the <a class="reference external" href="https://www.mathworks.com/help/matlab/ref/loadlibrary.html">loadlibrary</a> Matlab function,
which expects a “C-style” shared library. This means that C++ functions must be declared with <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span></code>
and Fortran 90 functions must be declared with the <code class="docutils literal notranslate"><span class="pre">bind(C)</span></code> attribute
(this means that Fortran 77 or earlier is not supported).</p></li>
<li><p>This also means that the function must be compiled as a shared-object (<code class="docutils literal notranslate"><span class="pre">.so</span></code>) library
(dynamically-linked library (<code class="docutils literal notranslate"><span class="pre">.dll</span></code>) in Windows).</p></li>
<li><p>To ensure that there are no heap memory errors, and to avoid slow-downs in copying large arrays,
the model function <em>must</em> use an pre-allocated array for the results
and should not allocate any arrays itself to return to Matlab
(e.g. C/C++ functions must return <code class="docutils literal notranslate"><span class="pre">void</span></code> and Fortran must functions must be declared as <code class="docutils literal notranslate"><span class="pre">subroutine</span></code>).</p></li>
<li><p>To allow the same interface for C/C++ and Fortran, the C/C++ functions must pass by reference.</p></li>
</ul>
<p>In addition, for the examples below we restrict to the case where no non-variable arguments are specified
(e.g. the first Matlab example where the temperature is included in the set of “variable” parameters
but is fixed by <code class="docutils literal notranslate"><span class="pre">set_free</span></code>).
This is not a general restriction but including such a facility is complex and may not be needed in most cases.
There is <a class="reference external" href="https://github.com/pace-neutrons/pace-developers/blob/master/optimisation/design/Third_Party_API_Design.md#-non-variable-parameters-in-compiled-user-models">some discussion here</a>
of how this could be done, and the interested user should contact a Horace developer for further help.</p>
<section id="prerequisites">
<h4><a class="toc-backref" href="#id24">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Permalink to this headline"></a></h4>
<p>Like the Python model function described above, we need to have a Matlab wrapper function:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>out<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">compiled_model</span><span class="p">(</span>h, k, l, en, p, libname, funcname<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">libpointer</span><span class="p">(</span><span class="s">&#39;doublePtr&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">libisloaded</span><span class="p">(</span><span class="n">libname</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">temp_header</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nb">tempname</span><span class="p">(),</span><span class="w"> </span><span class="s">&#39;.h&#39;</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">fid</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fopen</span><span class="p">(</span><span class="n">temp_header</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;w&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;void %s(const double *qh, const double *qk, const double *ql, &#39;</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">                      </span><span class="s">&#39;const double *en, const double *parameters, double *result, &#39;</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">                      </span><span class="s">&#39;int *n_elem);&#39;</span><span class="p">],</span><span class="w"> </span><span class="n">funcname</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nb">fclose</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nb">loadlibrary</span><span class="p">(</span><span class="n">libname</span><span class="p">,</span><span class="w"> </span><span class="n">temp_header</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">    </span><span class="nb">calllib</span><span class="p">(</span><span class="n">libname</span><span class="p">,</span><span class="w"> </span><span class="n">funcname</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">h</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>
</pre></div>
</div>
<p>Put the above code into a file <code class="docutils literal notranslate"><span class="pre">compiled_model.m</span></code>. Note that:</p>
<ul class="simple">
<li><p>The function requires a <code class="docutils literal notranslate"><span class="pre">libname</span></code> which is the name of the compiled shared library
(a <code class="docutils literal notranslate"><span class="pre">.so</span></code> file in Linux or <code class="docutils literal notranslate"><span class="pre">.dll</span></code> file in Windows) without the extension.
This library file must be on the Matlab path.</p></li>
<li><p>The Matlab <a class="reference external" href="https://www.mathworks.com/help/matlab/ref/loadlibrary.html">loadlibrary function</a>
is used to automatically load the library so it is not necessary for you to manually load it.</p></li>
<li><p>The Matlab <a class="reference external" href="https://www.mathworks.com/help/matlab/ref/libpointer.html">libpointer function</a>
is used to create an empty array <code class="docutils literal notranslate"><span class="pre">res</span></code> to hold the calculated intensity from the function.</p></li>
<li><p>Because the compiled function is passed as <em>pointers</em> to the arrays, it needs to know their size,
hence the final argument in the call to <code class="docutils literal notranslate"><span class="pre">calllib</span></code> is <code class="docutils literal notranslate"><span class="pre">numel(h)</span></code>, the number of array elements.</p></li>
</ul>
</section>
<section id="c-example">
<h4><a class="toc-backref" href="#id25">C example</a><a class="headerlink" href="#c-example" title="Permalink to this headline"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">fe_c_func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">en</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">n_elem</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">js</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">gam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">M_PI</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">js8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">js</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">qscal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="mf">2.87</span><span class="p">),</span><span class="w"> </span><span class="mf">2.</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">A</span><span class="o">=</span><span class="mf">0.0706</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="mf">35.008</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">=</span><span class="mf">0.3589</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="mf">15.358</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">=</span><span class="mf">0.5819</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="mf">5.561</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="o">=</span><span class="mf">-0.0114</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">E0</span><span class="p">,</span><span class="w"> </span><span class="n">q2</span><span class="p">,</span><span class="w"> </span><span class="n">ff</span><span class="p">,</span><span class="w"> </span><span class="n">e2E02</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;*</span><span class="n">n_elem</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">E0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">js8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">qh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ql</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span><span class="w"></span>
<span class="w">        </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qscal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">qh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">qh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ql</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">ql</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">ff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">e2E02</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">E0</span><span class="o">*</span><span class="n">E0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gam</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ff</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">amp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="mf">-11.602</span><span class="o">*</span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tt</span><span class="p">)))</span><span class="w"></span>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gam</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">om</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">e2E02</span><span class="o">*</span><span class="n">e2E02</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Put the above code into a file called <code class="docutils literal notranslate"><span class="pre">fe_sqw.c</span></code> and compile it with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>gcc -shared -o fe_sqw_c.so fe_sqw.c
</pre></div>
</div>
<p>Put the compiled library file into a folder on the Matlab path, and run the fit with:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit_sqw</span><span class="p">(</span><span class="n">w_fe</span><span class="p">)</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">compiled_model</span><span class="p">,</span><span class="w"> </span><span class="p">{[</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">gam</span><span class="p">,</span><span class="w"> </span><span class="n">amp</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">],</span><span class="w"> </span><span class="s">&#39;fe_sqw_c&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;fe_c_func&#39;</span><span class="p">})</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_free</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bfun</span><span class="w"> </span><span class="p">(@</span><span class="n">linear_bg</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bfree</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="w"></span>
<span class="p">[</span><span class="n">wfit</span><span class="p">,</span><span class="w"> </span><span class="n">fitdata</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">fit</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id2">
<h4><a class="toc-backref" href="#id26">C++ example</a><a class="headerlink" href="#id2" title="Permalink to this headline"></a></h4>
<p>Create a file <code class="docutils literal notranslate"><span class="pre">fe_sqw.cpp</span></code> with:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span><span class="cp"></span>

<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">fe_cpp_func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">en</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">n_elem</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">js</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">gam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">amp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">M_PI</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">js8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">js</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">qscal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="mf">2.87</span><span class="p">),</span><span class="w"> </span><span class="mf">2.</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">A</span><span class="o">=</span><span class="mf">0.0706</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="mf">35.008</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">=</span><span class="mf">0.3589</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="mf">15.358</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">=</span><span class="mf">0.5819</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="mf">5.561</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="o">=</span><span class="mf">-0.0114</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">E0</span><span class="p">,</span><span class="w"> </span><span class="n">q2</span><span class="p">,</span><span class="w"> </span><span class="n">ff</span><span class="p">,</span><span class="w"> </span><span class="n">e2E02</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;*</span><span class="n">n_elem</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">E0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">js8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">qh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ql</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span><span class="w"></span>
<span class="w">        </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qscal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">qh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">qh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">qk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ql</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">ql</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">ff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">e2E02</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">E0</span><span class="o">*</span><span class="n">E0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gam</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ff</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">amp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="mf">-11.602</span><span class="o">*</span><span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tt</span><span class="p">)))</span><span class="w"></span>
<span class="w">                    </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gam</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">E0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">e2E02</span><span class="o">*</span><span class="n">e2E02</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"> </span><span class="c1">// extern &quot;C&quot;</span>
</pre></div>
</div>
<p>Compile it using:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>g++ -shared -o fe_sqw_cpp.so fe_sqw.cpp
</pre></div>
</div>
<p>Put the compiled library file into a folder on the Matlab path, and run the fit with the
same script as above, except that the function is now:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">compiled_model</span><span class="p">,</span><span class="w"> </span><span class="p">{[</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">gam</span><span class="p">,</span><span class="w"> </span><span class="n">amp</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">],</span><span class="w"> </span><span class="s">&#39;fe_sqw_cpp&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;fe_cpp_func&#39;</span><span class="p">})</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="fortran-example">
<h4><a class="toc-backref" href="#id27">Fortran example</a><a class="headerlink" href="#fortran-example" title="Permalink to this headline"></a></h4>
<p>Create a file <code class="docutils literal notranslate"><span class="pre">fe_sqw.f90</span></code> with:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">fe_f90_func</span><span class="p">(</span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">,</span><span class="w"> </span><span class="n">n_elem</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">PI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.1415926535897932385</span><span class="w"></span>

<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">n_elem</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="w"></span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">parameters</span><span class="w"></span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">n_elem</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">results</span><span class="w"></span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n_elem</span><span class="w"></span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">js</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">gam</span><span class="p">,</span><span class="w"> </span><span class="n">tt</span><span class="p">,</span><span class="w"> </span><span class="n">amp</span><span class="p">,</span><span class="w"> </span><span class="n">qscal</span><span class="w"></span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">E0</span><span class="p">,</span><span class="w"> </span><span class="n">q2</span><span class="p">,</span><span class="w"> </span><span class="n">ff</span><span class="p">,</span><span class="w"> </span><span class="n">e2E02</span><span class="p">,</span><span class="w"> </span><span class="n">game</span><span class="w"></span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0706</span><span class="p">,</span><span class="w"> </span><span class="n">aa</span><span class="o">=</span><span class="mi">3</span><span class="mf">5.008</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">=</span><span class="mf">0.3589</span><span class="p">,</span><span class="w"> </span><span class="n">bb</span><span class="o">=</span><span class="mi">1</span><span class="mf">5.358</span><span class="w"></span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">C</span><span class="o">=</span><span class="mf">0.5819</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="o">=</span><span class="mf">5.561</span><span class="p">,</span><span class="w"> </span><span class="n">DD</span><span class="o">=-</span><span class="mf">0.0114</span><span class="w"></span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="w"></span>

<span class="w">    </span><span class="n">js</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">gam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">amp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameters</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PI</span><span class="w"></span>
<span class="w">    </span><span class="n">qscal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">2.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.87</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="w"></span>

<span class="w">    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n_elem</span><span class="w"></span>
<span class="w">        </span><span class="n">E0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">js</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">qh</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">qk</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ql</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qscal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">qh</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">qh</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qk</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">qk</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ql</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">ql</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">ff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">aa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">bb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">cc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DD</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">e2E02</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">en</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">en</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">E0</span><span class="o">*</span><span class="n">E0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">game</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gam</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">en</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">results</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ff</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">amp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">en</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="mf">1.602</span><span class="o">*</span><span class="n">en</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tt</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="w">                     </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gam</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">E0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">e2E02</span><span class="o">*</span><span class="n">e2E02</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">game</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end do</span>

<span class="k">end subroutine </span><span class="n">user_model_sqw</span><span class="w"></span>
</pre></div>
</div>
<p>Compile it using:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>gfortran -shared -o fe_sqw_f90.so fe_sqw.f90
</pre></div>
</div>
<p>Put the compiled library file into a folder on the Matlab path, and run the fit with the
same script as above, except that the function is now:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">compiled_model</span><span class="p">,</span><span class="w"> </span><span class="p">{[</span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">gam</span><span class="p">,</span><span class="w"> </span><span class="n">amp</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">],</span><span class="w"> </span><span class="s">&#39;fe_sqw_f90&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;fe_f90_func&#39;</span><span class="p">})</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Resolution_convolution.html" class="btn btn-neutral float-left" title="Resolution Convolution" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Example_scripts.html" class="btn btn-neutral float-right" title="Example scripts" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2006-2021, STFC RAL.
      <span class="lastupdated">Last updated on Feb 9, 2022, 1:56:42 PM.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>