<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulation &mdash; Horace  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Multifit" href="Multifit.html" />
    <link rel="prev" title="Plotting" href="Plotting.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Horace
            <img src="../_static/150px-Quintus_Horatius_Flaccus.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../User_guide.html">User’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../Horace_manual.html">Horace Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Changing_Horace_settings.html">Changing Horace settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="Planning_a_Horace_scan.html">Planning a Horace scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="Generating_SQW_files.html">Generating SQW files</a></li>
<li class="toctree-l2"><a class="reference internal" href="Manipulating_and_extracting_data_from_SQW_files_and_objects.html">Manipulating and extracting data from SQW files and objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="Correcting_for_sample_misalignment.html">Correcting for sample misalignment</a></li>
<li class="toctree-l2"><a class="reference internal" href="Data_diagnostics.html">Data diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="Symmetrising_etc.html">Symmetrising etc</a></li>
<li class="toctree-l2"><a class="reference internal" href="Unary_operations.html">Unary operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Binary_operations.html">Binary operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Plotting.html">Plotting</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#func-eval">func_eval</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sqw-eval">sqw_eval</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dispersion">dispersion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#disp2sqw-eval">disp2sqw_eval</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dispersion-plot">dispersion_plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#disp2sqw-plot">disp2sqw_plot</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Multifit.html">Multifit</a></li>
<li class="toctree-l2"><a class="reference internal" href="Advanced_Multifit.html">Advanced Multifit</a></li>
<li class="toctree-l2"><a class="reference internal" href="Tobyfit.html">Tobyfit</a></li>
<li class="toctree-l2"><a class="reference internal" href="Parallel.html">Running Horace in Parallel</a></li>
<li class="toctree-l2"><a class="reference internal" href="List_of_functions.html">List of functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Input_file_formats.html">Input file formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Unsorted.html">Unsorted Manual Pages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Citing.html">Citing Horace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developers.html">For Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Contributing.html">Contributing to Horace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API_Reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../General_disclaimer.html">General disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Privacy_policy.html">Privacy Policy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Horace</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../Horace_manual.html">Horace Manual</a></li>
      <li class="breadcrumb-item active">Simulation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/manual/Simulation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="simulation">
<h1>Simulation<a class="headerlink" href="#simulation" title="Permalink to this heading"></a></h1>
<p>There are a variety of simulation tools available in Horace, so that if you have a theoretical model to describe your data you can simulate the results for the specific data points that you measured.</p>
<p><strong>IMPORTANT</strong> When simulating an S(Q,w) model (see sqw_eval below), bear in mind the difference between what is calculated for equivalent dnd and sqw datasets. See <a class="reference internal" href="FAQ.html#faq"><span class="std std-ref">FAQ</span></a>.</p>
<section id="func-eval">
<h2>func_eval<a class="headerlink" href="#func-eval" title="Permalink to this heading"></a></h2>
<p>This evaluates a user-supplied function at the x, y, z, … values of an n-dimensional dataset, or array of datasets. The syntax is as follows:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">wout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">func_eval</span><span class="p">(</span><span class="n">win</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="n">myfunc</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="n">wout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">func_eval</span><span class="p">(</span><span class="n">win</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="n">myfunc</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;all&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">win</span></code> is the input dataset or array of datasets (sqw or dnd type) for which you wish to perform a simulation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">myfunc</span></code> is the name of a user-defined function to calculate the intensity at the points in the dataset(s). The function must be of the form <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">mfunc(x1,</span> <span class="pre">x2,</span> <span class="pre">...,</span> <span class="pre">xn,</span> <span class="pre">p)</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">gauss2d(x1,</span> <span class="pre">x2,</span> <span class="pre">[amplitude,</span> <span class="pre">centre1,</span> <span class="pre">centre2,</span> <span class="pre">width1,</span> <span class="pre">width2,</span> <span class="pre">background])</span></code> and accept equal sized arrays that contain the x1, x2, … values. <code class="docutils literal notranslate"><span class="pre">p</span></code> can be a row-vector containing the parameters needed by the function.</p></li>
</ul>
<p>The optional keyword <code class="docutils literal notranslate"><span class="pre">'all'</span></code> is used if you wish to calculate the intensity from the function over the whole domain covered by the input dataset. In other words, your dataset may contain gaps due to the trajectory of the detectors through reciprocal space, but you may wish to simulate the scattering even in the gaps. This option applies in the case of dnd objects, but not sqw objects.</p>
</section>
<section id="sqw-eval">
<h2>sqw_eval<a class="headerlink" href="#sqw-eval" title="Permalink to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">wout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sqw_eval</span><span class="p">(</span><span class="n">win</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="n">my_sqw_func</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="n">wout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sqw_eval</span><span class="p">(</span><span class="n">win</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="n">my_sqw_func</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;all&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The syntax for <code class="docutils literal notranslate"><span class="pre">sqw_eval</span></code> is almost identical to that of <code class="docutils literal notranslate"><span class="pre">func_eval</span></code>. The only difference is the form of the function required <code class="docutils literal notranslate"><span class="pre">my_sqw_func</span></code>, which <strong>must</strong> be of the form</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">weight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">my_sqw_func</span><span class="p">(</span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">qh,</span> <span class="pre">qk,</span> <span class="pre">ql,</span> <span class="pre">en</span></code> area arrays that contain the co-ordinates in h, k, l and energy of every point in the dataset, irrespective of the dimensionality of that dataset. As before, <code class="docutils literal notranslate"><span class="pre">p</span></code> is a row-vector containing the parameters required by the function. These could be the values of exchange constants, intensity scale factor, or temperature, for example.</p>
<p>One would generally use <code class="docutils literal notranslate"><span class="pre">sqw_eval</span></code> in preference to <code class="docutils literal notranslate"><span class="pre">func_eval</span></code> if, for example, one had a model of the spin-wave cross-section for magnetic scattering.</p>
</section>
<section id="dispersion">
<h2>dispersion<a class="headerlink" href="#dispersion" title="Permalink to this heading"></a></h2>
<p>Calculate dispersion relation for dataset or array of datasets.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">wdisp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dispersion</span><span class="w"> </span><span class="p">(</span><span class="n">win</span><span class="p">,</span><span class="w"> </span><span class="n">dispreln</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w">            </span><span class="c">% dispersion only</span><span class="w"></span>

<span class="p">[</span><span class="n">wdisp</span><span class="p">,</span><span class="n">weight</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dispersion</span><span class="w"> </span><span class="p">(</span><span class="n">win</span><span class="p">,</span><span class="w"> </span><span class="n">dispreln</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w">   </span><span class="c">% dispersion and spectral weight</span><span class="w"></span>
</pre></div>
</div>
<p>The output dataset (or array of data sets), <code class="docutils literal notranslate"><span class="pre">wdisp</span></code>, will retain only the Q axes, and the signal array(s) will contain the values of energy along the Q axes. If the dispersion relation returns the spectral weight, this will be placed in the error array (actually the square of the spectral weight is put in the error array). In the case when the dispersion has been calculated on a plane in momentum (i.e. wdisp is IX_datset_2d) then the plot function</p>
<p><code class="docutils literal notranslate"><span class="pre">ds2</span></code> (for draw surface from two arrays)</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">ds2</span><span class="p">(</span><span class="n">wdisp</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>will plot a surface with the z axis as energy and coloured according to the spectral weight.</p>
<p><strong>If you wish to overplot a dispersion relation on top of, for example, a Q-E slice from your data, then you would use:</strong></p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">plot</span><span class="p">(</span><span class="n">my_qe_slice</span><span class="p">)</span><span class="w"></span>

<span class="n">ploc</span><span class="p">(</span><span class="n">wdisp</span><span class="p">)</span><span class="w">       </span><span class="c">% for plot line on current</span><span class="w"></span>
</pre></div>
</div>
<p>Note that in the above there must not be a <em>keep</em> command between plotting the Q-E slice and plotting the dispersion, since the <code class="docutils literal notranslate"><span class="pre">ploc</span></code> command works on the <em>current</em> figure.</p>
<p>The dispersion relation is calculated at the bin centres (that is, the individual pixel information in a sqw input object is not used).</p>
<p>If the function that calculates dispersion relations produces more than one branch (i.e. the output of <code class="docutils literal notranslate"><span class="pre">dispreln</span></code> is a cell array of arrays), then in the case of a single input dataset the output will be an array of datasets, one for each branch. If the input is an array of datasets, then only the first dispersion branch will be returned, so there is one output dataset per input dataset.</p>
<p>Input:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">win</span></code> Dataset (or array of datasets) that provides the axes and points for the calculation. If one of the plot axes is energy transfer, then the output dataset will have dimensionality one less than the input dataset.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dispreln</span></code> Handle to function that calculates the dispersion relation w(Q). Must have form:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">w</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p)</span></code>, or <code class="docutils literal notranslate"><span class="pre">[w,s]</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p)</span></code></p></li>
</ul>
<p>where</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">qh,qk,ql</span></code> Arrays containing the coordinates of a set of points in reciprocal lattice units</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> Vector of parameters needed by dispersion function , e.g. [A,js,gam] as intensity, exchange, lifetime</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">w</span></code> Array of corresponding energies, or, if more than one dispersion relation, a cell array of arrays.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s</span></code> Array of corresponding spectral weights, or, if more than one dispersion relation, a cell array of arrays.</p></li>
</ul>
<p>The more general form is: <code class="docutils literal notranslate"><span class="pre">w</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p,c1,c2,..)</span></code>, or <code class="docutils literal notranslate"><span class="pre">[w,s]</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p,c1,c2,..)</span></code></p>
<p>where</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> Typically a vector of parameters that we might want to fit in a least-squares algorithm</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c1,c2,...</span></code> Other constant parameters e.g. file name for look-up table</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> Arguments needed by the function that calculates the dispersion relation(s). Most commonly, a vector of parameter values e.g. [A,js,gam] as intensity, exchange, lifetime. If a more general set of parameters is required by the dispersion relation function, then package these into a cell array {p, c1, c2, …}.</p></li>
</ul>
<p>The output is:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">wdisp</span></code> Output dataset or array of datasets. Output is always dnd-type. The output dataset (or array of data sets) will retain only the Q axes, the the signal array(s) will contain the values of energy along the Q axes, and the error array will contain the square of the spectral weight. If the function that calculates dispersion relations produces more than one branch, then in the case of a single input dataset the output will be an array of datasets, one for each branch. If the input is an array of datasets, then only the first dispersion branch will be returned, so there is one output dataset per input dataset.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">weight</span></code> Mirror output: the signal is the spectral weight, and the error array contains the square of the frequency.</p></li>
</ul>
<p>e.g. If <code class="docutils literal notranslate"><span class="pre">win</span></code> is a 2D dataset with Q and E axes, then <code class="docutils literal notranslate"><span class="pre">wdisp</span></code> is a 1D dataset with just the Q axis</p>
</section>
<section id="disp2sqw-eval">
<h2>disp2sqw_eval<a class="headerlink" href="#disp2sqw-eval" title="Permalink to this heading"></a></h2>
<p>Similar to <code class="docutils literal notranslate"><span class="pre">sqw_eval</span></code>, but takes as the input function a routine that calculates both the dispersion and the spectral weight, and only requires as its inputs h, k, l and some model parameters.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">wout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">disp2sqw_eval</span><span class="p">(</span><span class="n">win</span><span class="p">,@</span><span class="n">dispreln</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">fwhh</span><span class="p">,</span><span class="o">&lt;</span><span class="n">Optional</span><span class="w"> </span><span class="nb">input</span><span class="w"> </span><span class="n">parameters</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">win</span></code> is the input dataset (sqw or dnd) or array of datasets</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dispreln</span></code> is a function of the form <code class="docutils literal notranslate"><span class="pre">[w,s]</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p)</span></code>, or more generally <code class="docutils literal notranslate"><span class="pre">[w,s]</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p,c1,c2,..)</span></code>, where in addition to the coordinates <code class="docutils literal notranslate"><span class="pre">qh,</span> <span class="pre">qk,</span> <span class="pre">ql</span></code> and model input parameters <code class="docutils literal notranslate"><span class="pre">p</span></code>, some extra information contained in the data structures (cell arrays, vectors, structure arrays, etc) <code class="docutils literal notranslate"><span class="pre">c1,</span> <span class="pre">c2,</span> <span class="pre">...</span></code> is supplied. The outputs <code class="docutils literal notranslate"><span class="pre">w</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code> are the dispersion and spectral weight respectively. These are cell arrays of arrays if there is more than one branch of the dispersion.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pars</span></code> is the input parameters to the function. If this is just <code class="docutils literal notranslate"><span class="pre">p</span></code> then <code class="docutils literal notranslate"><span class="pre">pars</span> <span class="pre">=</span> <span class="pre">p</span></code>, but if extra parameters are required then <code class="docutils literal notranslate"><span class="pre">pars</span> <span class="pre">=</span> <span class="pre">{p,</span> <span class="pre">c1,</span> <span class="pre">c2,</span> <span class="pre">...}</span></code>, i.e. <code class="docutils literal notranslate"><span class="pre">pars</span></code> is a cell array.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fwhh</span></code> is the full-width half-height of Gaussian broadening applied to dispersion relation.</p></li>
</ul>
<p>The optional inputs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'all'</span></code> - Requests that the calculated sqw be returned over the whole of the domain of the input dataset. If not given, then the function will be returned only at those points of the dataset that contain data. Applies only to input with no pixel information - it is ignored if full sqw object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'ave'</span></code> - Requests that the calculated sqw be computed for the average values of h,k,l of the pixels in a bin, not for each pixel individually. Reduces cost of expensive calculations. Applies only to the case of sqw object with pixel information - it is ignored if dnd type object.</p></li>
</ul>
<p>The output is:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">wout</span></code> - Output dataset or array of datasets</p></li>
</ul>
</section>
<section id="dispersion-plot">
<h2>dispersion_plot<a class="headerlink" href="#dispersion-plot" title="Permalink to this heading"></a></h2>
<p>Plot dispersion relation or array of dispersion relations along a path in reciprocal space. It can be called in the following ways, with or without outputs, as below:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">dispersion_plot</span><span class="p">(</span><span class="n">rlp</span><span class="p">,@</span><span class="n">dispreln</span><span class="p">,</span><span class="n">pars</span><span class="p">)</span><span class="w"></span>

<span class="n">dispersion_plot</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span><span class="n">rlp</span><span class="p">,@</span><span class="n">dispreln</span><span class="p">,</span><span class="n">pars</span><span class="p">)</span><span class="w"></span>

<span class="n">dispersion_plot</span><span class="p">(</span><span class="k">...</span><span class="c">,&#39;dispersion&#39;) % plot dispersion only</span><span class="w"></span>

<span class="n">dispersion_plot</span><span class="p">(</span><span class="k">...</span><span class="c">,&#39;weight&#39;) % plot spectral weight only</span><span class="w"></span>

<span class="n">dispersion_plot</span><span class="p">(</span><span class="k">...</span><span class="c">,&#39;labels&#39;,{&#39;G&#39;,&#39;X&#39;,...})  % customised labels at the positions of the rlp</span><span class="w"></span>

<span class="n">dispersion_plot</span><span class="p">(</span><span class="k">...</span><span class="c">,&#39;ndiv&#39;,n)   % plot with number of points per interval other than the default</span><span class="w"></span>

<span class="p">[</span><span class="n">wdisp</span><span class="p">,</span><span class="n">weight</span><span class="p">]=</span><span class="n">dispersion_plot</span><span class="p">(</span><span class="k">...</span><span class="c">)  % output arrays of IX_dataset_1d with dispersion and spectral weight</span><span class="w"></span>

<span class="p">[</span><span class="n">wdisp</span><span class="p">,</span><span class="n">weight</span><span class="p">]=</span><span class="n">dispersion_plot</span><span class="p">(</span><span class="k">...</span><span class="c">,&#39;noplot&#39;) % output arrays without plotting</span><span class="w"></span>
</pre></div>
</div>
<p>The inputs are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lattice</span></code> [optional] Lattice parameters [a,b,c,alpha,beta,gamma] (Angstrom, degrees). Default is [2*pi,2*pi,2pi,90,90,90]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rlp</span></code> Array of reciprocal lattice points, e.g. [0,0,0; 0,0,1; 0,-1,1; 1,-1,1; 1,0,1; 1,0,0];</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;dispreln</span></code> Handle to a Matlab function <code class="docutils literal notranslate"><span class="pre">dispreln</span></code>) that calculates the dispersion relation w(Q) and spectral weight, S(Q).</p></li>
</ul>
<p>The most commonly used form is:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[w,s]</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p)</span></code></p></li>
</ul>
<p>where,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">qh,qk,ql</span></code> Arrays containing the coordinates of a set of points in reciprocal lattice units</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> Vector of parameters needed by dispersion function e.g. [A,js,gam] as intensity, exchange, lifetime</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">w</span></code> Array of corresponding energies, or, if more than one dispersion relation, a cell array of arrays.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s</span></code> Array of spectral weights, or, if more than one dispersion relation, a cell array of arrays.</p></li>
</ul>
<p>The more general form is:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[w,s]</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p,c1,c2,..)</span></code></p></li>
</ul>
<p>where,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> Typically a vector of parameters that we might want to fit in a least-squares algorithm</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c1,c2,...</span></code> Other constant parameters e.g. file name for look-up table.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pars</span></code> Arguments needed by the function that calculates the dispersion relation. Most commonly, a vector of parameter values e.g. [A,js,gam] as intensity, exchange, lifetime. If a more general set of parameters is required by the function, then package these into a cell array and pass that as pars. In the example above then pars = {p, c1, c2, …}</p></li>
</ul>
<p>The keyword options (which can be abbreviated to single letter) are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'dispersion'</span></code> Only plot the dispersion relation(s). The default is to plot and/or return dispersion, and weight if available</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'weight'</span></code> Only plot the spectral weight(s). The default is to plot and/or return dispersion, and weight if available</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'labels'</span></code> Tick labels to place at the positions of the Q points in argument rlp. e.g. {‘G’,’X’,’M’,’R’}. By default the labels are character representations of rlp, e.g. {0,0,0; 0.5,0,0; 0.5,0.5,0; 0.5,0.5,0.5} becomes {‘0,0,0’, ‘0.5,0,0’, ‘0.5,0.5,0’, ‘0.5,0.5,0.5’}</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'ndiv'</span></code> \tNumber of points into which to divide the interval between two r.l.p. (default=100)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'noplot'</span></code> Do not plot, just return the output IX_dataset_1d (see below)</p></li>
</ul>
<p>The outputs are as follows</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">wdisp</span></code> Array of IX_dataset_1d containing dispersion, one per dispersion relation. The x-axis is the distance in Ang^-1 along the path described</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">weight</span></code> Array of IX_dataset_1d with corresponding spectral weight, one per dispersion relation</p></li>
</ul>
</section>
<section id="disp2sqw-plot">
<h2>disp2sqw_plot<a class="headerlink" href="#disp2sqw-plot" title="Permalink to this heading"></a></h2>
<p>Generate an Q-E intensity plot for a dispersion relation along a path in reciprocal space. The function is very closely related to <code class="docutils literal notranslate"><span class="pre">dispersion_plot</span></code>), and most of the input arguments and options are the same for the two functions.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">disp2sqw_plot</span><span class="p">(</span><span class="n">rlp</span><span class="p">,@</span><span class="n">dispreln</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">ebins</span><span class="p">,</span><span class="n">fwhh</span><span class="p">)</span><span class="w"></span>

<span class="n">disp2sqw_plot</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span><span class="n">rlp</span><span class="p">,@</span><span class="n">dispreln</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">ebins</span><span class="p">,</span><span class="n">fwhh</span><span class="p">)</span><span class="w"></span>

<span class="n">disp2sqw_plot</span><span class="p">(</span><span class="k">...</span><span class="c">,&#39;labels&#39;,{&#39;G&#39;,&#39;X&#39;,...})  % customised labels at the positions of the rlp</span><span class="w"></span>

<span class="n">disp2sqw_plot</span><span class="p">(</span><span class="k">...</span><span class="c">,&#39;ndiv&#39;,n)   % plot with number of points per interval other than the default</span><span class="w"></span>

<span class="n">weight</span><span class="p">=</span><span class="n">disp2sqw_plot</span><span class="p">(</span><span class="k">...</span><span class="c">)  % output IX_dataset_2d with spectral weight</span><span class="w"></span>

<span class="n">weight</span><span class="p">=</span><span class="n">disp2sqw_plot</span><span class="p">(</span><span class="k">...</span><span class="c">,&#39;noplot&#39;) % output array without plotting</span><span class="w"></span>
</pre></div>
</div>
<p>The inputs are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lattice</span></code> [optional] Lattice parameters [a,b,c,alpha,beta,gamma] (Angstrom, degrees). Default is [2*pi,2*pi,2pi,90,90,90]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rlp</span></code> Array of reciprocal lattice points, e.g. [0,0,0; 0,0,1; 0,-1,1; 1,-1,1; 1,0,1; 1,0,0];</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;dispreln</span></code> Handle to a Matlab function <code class="docutils literal notranslate"><span class="pre">dispreln</span></code>) that calculates the dispersion relation w(Q) and spectral weight, S(Q).</p></li>
</ul>
<p>The most commonly used form is:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[w,s]</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p)</span></code></p></li>
</ul>
<p>where,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">qh,qk,ql</span></code> Arrays containing the coordinates of a set of points in reciprocal lattice units</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> Vector of parameters needed by dispersion function e.g. [A,js,gam] as intensity, exchange, lifetime</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">w</span></code> Array of corresponding energies, or, if more than one dispersion relation, a cell array of arrays.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s</span></code> Array of spectral weights, or, if more than one dispersion relation, a cell array of arrays.</p></li>
</ul>
<p>The more general form is:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[w,s]</span> <span class="pre">=</span> <span class="pre">dispreln</span> <span class="pre">(qh,qk,ql,p,c1,c2,..)</span></code></p></li>
</ul>
<p>where,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> Typically a vector of parameters that we might want to fit in a least-squares algorithm</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c1,c2,...</span></code> Other constant parameters e.g. file name for look-up table.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pars</span></code> Arguments needed by the function that calculates the dispersion relation. Most commonly, a vector of parameter values e.g. [A,js,gam] as intensity, exchange, lifetime. If a more general set of parameters is required by the function, then package these into a cell array and pass that as pars. In the example above then pars = {p, c1, c2, …}</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ebins</span></code> Defines the energy bin centres: a three-vector [ecentre_lo, bin_width, ecentre_hi]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fwhh</span></code> Full width half height of broadening applied to the dispersion to produce the intensity map</p></li>
</ul>
<p>The keyword options (which can be abbreviated to single letter) are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'labels'</span></code> Tick labels to place at the positions of the Q points in argument rlp. e.g. {‘G’,’X’,’M’,’R’}. By default the labels are character representations of rlp, e.g. {0,0,0; 0.5,0,0; 0.5,0.5,0; 0.5,0.5,0.5} becomes {‘0,0,0’, ‘0.5,0,0’, ‘0.5,0.5,0’, ‘0.5,0.5,0.5’}</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'ndiv'</span></code> \tNumber of points into which to divide the interval between two r.l.p. (default=100)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'noplot'</span></code> Do not plot, just return the output IX_dataset_1d (see below)</p></li>
</ul>
<p>The output is as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">weight</span></code> IX_dataset_2d containing the spectra weight. The x-axis is the distance in Ang^-1 along the path described</p></li>
</ul>
<p>The image intensity, as the function of <strong>Q</strong> along the rlp path alonx x-axis and the energy transfer along y-axis is determined by the equation:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">weight</span><span class="p">(</span><span class="n">energy</span><span class="p">)=</span><span class="w"> </span><span class="n">sfact</span><span class="o">.*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="p">(</span><span class="o">**</span><span class="n">Q</span><span class="o">**</span><span class="p">,</span><span class="o">\</span><span class="w"> </span><span class="o">**</span><span class="n">p</span><span class="o">**</span><span class="p">)</span><span class="o">-</span><span class="n">energy</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig</span><span class="o">.^</span><span class="mi">2</span><span class="p">))</span><span class="o">./</span><span class="p">(</span><span class="n">sig</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
<p>where</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">sig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fwhh</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">log</span><span class="p">(</span><span class="mi">256</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Plotting.html" class="btn btn-neutral float-left" title="Plotting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Multifit.html" class="btn btn-neutral float-right" title="Multifit" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2006-2022, STFC RAL.
      <span class="lastupdated">Last updated on Nov 16, 2022, 1:44:40 PM.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
<br><br>
<a href="https://github.com/pace-neutrons/Horace/edit/master/documentation/user_docs/docs/manual/Simulation.rst">Click here to edit</a> or <a href="https://github.com/pace-neutrons/Horace/edit/master/documentation/user_docs/docs/new_page.rst">Click here to add new page</a> (requires <a href="https://github.com/login">GitHub account</a>).
<br>
For more info on editing <a href="../Contributing.html">click here</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>