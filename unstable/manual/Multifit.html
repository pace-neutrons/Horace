

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>15. Multifit &mdash; Horace  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="16. Tobyfit" href="Tobyfit.html" />
    <link rel="prev" title="14. Simulation" href="Simulation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Horace
              <img src="../_static/150px-Quintus_Horatius_Flaccus.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../User_guide.html">User’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../Horace_manual.html">Horace Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Planning_a_Horace_scan.html">1. Planning a Horace scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="Generating_SQW_files.html">2. Generating SQW files</a></li>
<li class="toctree-l2"><a class="reference internal" href="Data_diagnostics.html">3. Data diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="Correcting_for_sample_misalignment.html">4. Correcting for sample misalignment</a></li>
<li class="toctree-l2"><a class="reference internal" href="Cutting_data_of_interest_from_SQW_files_and_objects.html">5. Cutting data of interest from SQW files and objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="Special_sqw_information.html">6. Special <code class="docutils literal notranslate"><span class="pre">SQW</span></code> information from sqw objects and files</a></li>
<li class="toctree-l2"><a class="reference internal" href="Save_and_load.html">7. Loading <code class="docutils literal notranslate"><span class="pre">sqw</span></code> and <code class="docutils literal notranslate"><span class="pre">dnd</span></code> objects to memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="Save_and_load.html#saving-sqw-objects-from-memory-and-creating-filebacked-objects">8. Saving sqw objects from memory and creating filebacked objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="Reshaping_etc.html">9. Other shape functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Symmetrising_etc.html">10. Symmetry Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Unary_operations.html">11. Unary operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Binary_operations.html">12. Binary operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Plotting.html">13. Plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="Simulation.html">14. Simulation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">15. Multifit</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">15.1. Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#introduction-to-setting-up-and-performing-a-fit">15.2. Introduction to setting up and performing a fit</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#simple-fitting">15.2.1. Simple fitting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#background-functions">15.2.2. Background functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#binding-parameters">15.2.3. Binding parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#semi-global-fits">15.2.4. Semi-global fits</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#summary-of-commands-with-multifit">15.3. Summary of commands with multifit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fitting-functions">15.4. Fitting functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#multifit-function">15.4.1. multifit function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multifit-func">15.4.2. multifit_func</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multifit-sqw">15.4.3. multifit_sqw</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multifit-sqw-sqw">15.4.4. multifit_sqw_sqw</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#parallel-fitting">15.5. Parallel fitting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Tobyfit.html">16. Tobyfit</a></li>
<li class="toctree-l2"><a class="reference internal" href="Parallel.html">17. Running Horace in Parallel</a></li>
<li class="toctree-l2"><a class="reference internal" href="Changing_Horace_settings.html">18. Changing Horace settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="List_of_functions.html">List of functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Input_file_formats.html">Input file formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="FAQ.html">FAQ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Example_scripts.html">Example Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Citing.html">Citing Horace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developers.html">For Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Contributing.html">Contributing to Horace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../General_disclaimer.html">General disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Previous_versions.html">Previous Versions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Horace</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Horace_manual.html">Horace Manual</a></li>
      <li class="breadcrumb-item active"><span class="section-number">15. </span>Multifit</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/manual/Multifit.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="multifit">
<h1><span class="section-number">15. </span>Multifit<a class="headerlink" href="#multifit" title="Permalink to this heading"></a></h1>
<p>Horace comes with a rich and powerful fitting syntax that is common to the
methods used to fit functions or models of <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span> to one or more datasets.</p>
<section id="overview">
<h2><span class="section-number">15.1. </span>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>Horace provides a set of methods for fitting <code class="docutils literal notranslate"><span class="pre">sqw</span></code> and <code class="docutils literal notranslate"><span class="pre">d1d</span></code>, <code class="docutils literal notranslate"><span class="pre">d2d</span></code>,
<code class="docutils literal notranslate"><span class="pre">d3d</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">d4d</span></code> objects, which all share the same fitting syntax and
capabilities. The various forms of multifit enable you to:</p>
<ul>
<li><p>fit a function to single dataset</p>
<p>For example, fitting a Gaussian function to a single one-dimensional dataset</p>
</li>
<li><p>fit a function with a global set of parameters to several datasets
simultaneously</p>
<p>For example, fitting a model for <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span> from spin waves to several
function <code class="docutils literal notranslate"><span class="pre">sqw</span></code> objects to determine the global intensity scale and magnetic
exchange constants that best fit the set of data</p>
</li>
<li><p>fit a global foreground function with local background functions</p>
<p>For example, in the previous illustration, allowing an independent linear
background for each <code class="docutils literal notranslate"><span class="pre">sqw</span></code> dataset, or even different functional forms for
the background for different datasets</p>
</li>
<li><p>fix one or more parameters in the foreground functions and background
functions</p></li>
<li><p>bind the values of pairs of parameters so that they vary in a fixed ratio in
the fit</p></li>
</ul>
<p>The last functionality can be very useful if you have a model for <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span>
where you want to have parameters that apply globally (for example, magnetic
exchange constants that define spin wave dispersion) but other parameters that
can vary independently for each dataset (for example, the spin wave lifetime)
. In this instance, you can define the foreground function to be local, then
bind the exchange constants across all datasets with ratio unity.</p>
<p>The following multifit variants are available for <code class="docutils literal notranslate"><span class="pre">sqw</span></code> and <code class="docutils literal notranslate"><span class="pre">d1d</span></code>, <code class="docutils literal notranslate"><span class="pre">d2d</span></code>,
<code class="docutils literal notranslate"><span class="pre">d3d</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">d4d</span></code> objects:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">multifit_func</span></code> (or equivalently <code class="docutils literal notranslate"><span class="pre">multifit</span></code>)</p>
<p>The foreground and background functions both are functions of the plot axes
x1, x2, …</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">multifit_sqw</span></code></p>
<p>The foreground function(s) are functions of <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span>, and the background
functions are functions of the plot axes x1, x2, …</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">multifit_sqw_sqw</span></code></p>
<p>The foreground and background function(s) are all functions of <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span></p>
</li>
</ul>
</section>
<section id="introduction-to-setting-up-and-performing-a-fit">
<h2><span class="section-number">15.2. </span>Introduction to setting up and performing a fit<a class="headerlink" href="#introduction-to-setting-up-and-performing-a-fit" title="Permalink to this heading"></a></h2>
<p>All the variants of multifit share a common procedure for setting up and
performing a fit - they differ only in the form of the functions, which are
either functions of the plot coordinates or qh, qk, ql, en. In what follows we
refer to <code class="docutils literal notranslate"><span class="pre">multifit</span></code>, but the same information is true for <code class="docutils literal notranslate"><span class="pre">multifit_func</span></code>,
<code class="docutils literal notranslate"><span class="pre">multifit_sqw</span></code>, <code class="docutils literal notranslate"><span class="pre">multifit_sqw</span></code>, and <code class="docutils literal notranslate"><span class="pre">tobyfit</span></code>.</p>
<section id="simple-fitting">
<h3><span class="section-number">15.2.1. </span>Simple fitting<a class="headerlink" href="#simple-fitting" title="Permalink to this heading"></a></h3>
<p>First you have to create a multifit object with the data you want to fit. You
can give it any name you like - here we’ll use the name <code class="docutils literal notranslate"><span class="pre">kk</span></code></p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit</span><span class="p">(</span><span class="n">w1</span><span class="p">);</span><span class="w">   </span><span class="c">% w1 is an object (or array of objects) to be fitted</span>
</pre></div>
</div>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span><span class="w"> </span><span class="n">w2</span><span class="p">,</span><span class="w"> </span><span class="n">w3</span><span class="p">,</span><span class="w"> </span><span class="n">w4</span><span class="p">);</span><span class="w">   </span><span class="c">% several (arrays of) objects to be fitted simultaneously</span>
</pre></div>
</div>
<p>Next you need to set the fitting functions. In this case, let us assume that you
are fitting an array of three objects and that you are going to fit Gaussian
functions to all three objects simultaneously:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit</span><span class="w"> </span><span class="p">(</span><span class="n">my_data</span><span class="p">);</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">gauss</span><span class="p">);</span>
</pre></div>
</div>
<p>In the Horace installation there is a folder
(<code class="docutils literal notranslate"><span class="pre">herbert_core\applications\mfit_funcs</span></code>) with a selection of fitting
functions, including <code class="docutils literal notranslate"><span class="pre">gauss.m</span></code>. A fit function requires a particular set of
input and output arguments (see <a class="reference internal" href="#fitting-functions"><span class="std std-ref">Fitting functions</span></a>).</p>
<p>Now we need to provide the starting parameters for the fit. This is a row vector
of the numerical values for the parameters, which in the case of <code class="docutils literal notranslate"><span class="pre">gauss</span></code> is
the height, position and standard deviation:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_pin</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]);</span><span class="w"> </span><span class="c">% height 100, centred on 0, standard deviation 10</span>
</pre></div>
</div>
<p>By default, multifit will allow all these parameters to float freely in the
fit. However, suppose you want to keep the Gaussian centred on the origin. Then
you can provide a list of which parameters are allowed to float (1) or are fixed
(0). In this example:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_free</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="c">% keep the second parameter fixed in the fit</span>
</pre></div>
</div>
<p>At this point, you can perform a fit:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">my_fitted_data</span><span class="p">,</span><span class="w"> </span><span class="n">fit_params</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">fit</span><span class="p">();</span>
</pre></div>
</div>
<p>This returns two arguments: <code class="docutils literal notranslate"><span class="pre">my_fitted_data</span></code> is an array of objects which is
the same shape and types as the input data, where that the signal (or
equivalently, the intensity) is set to the calculated values at the final fitted
parameter values; and <code class="docutils literal notranslate"><span class="pre">fit_params</span></code>, which is a structure that contains the
fitted parameter values, estimated errors on those fitted values, the value of
chi-squared for the fit and the covariance matrix of the fitted parameters.</p>
<p>If you want to see how the fit is progressing from one iteration to the next,
and also get a listing in the Matlab command window of the final fit parameters,
you can ask for more verbose output by changing one of the multifit options:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_options</span><span class="p">(</span><span class="s">&#39;list&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c">% prints highly verbose output to the screen</span>
</pre></div>
</div>
<p>Other options change the fit convergence criteria, and whether or not the final
fit is calculated only for data points that remained once points with zero error
bars were removed or for all data points.</p>
<p>Fitting can be computationally very expensive. Before you start fitting, it can
be very useful to simulate at the initial parameters to see if your starting
point close to expected final values, it can be helpful to check visually using
simulate:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">my_fitted_data</span><span class="p">,</span><span class="w"> </span><span class="n">fit_params</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">simulate</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="background-functions">
<h3><span class="section-number">15.2.2. </span>Background functions<a class="headerlink" href="#background-functions" title="Permalink to this heading"></a></h3>
<p>One of the nice features of multifit is that as well as fitting a global
function (the ‘foreground’) function to all your datsets, you can define local
‘background’ functions, that is functions whose parameters vary independently
for each dataset. This can be useful, for example, if you have a model for
<span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span> which should apply to all your datasets, but you need to have a
linear background that is independent for each dataset. We continue with our
example of an array of three datasets which we set up above; to recap:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit</span><span class="w"> </span><span class="p">(</span><span class="n">my_data</span><span class="p">);</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">gauss</span><span class="p">);</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_pin</span><span class="w"> </span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]);</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_free</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
<p>Now let us add an independent linear background for each of the three datasets:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bfun</span><span class="w"> </span><span class="p">(@</span><span class="n">linear_bg</span><span class="p">);</span><span class="w"> </span><span class="c">% set_bfun sets the background functions</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bpin</span><span class="w"> </span><span class="p">([</span><span class="mf">5.5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span><span class="w">   </span><span class="c">% initial background constant and gradient</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bfree</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span><span class="w">    </span><span class="c">% fix the backgroun gradient</span>
</pre></div>
</div>
<p>Even though only one background function was given in the example above, the
default is assume that it applies locally. That is, multifit will assume that we
want an independent linear background for each dataset. The same is true of the
initial parameter values and the free/fixed parameters.</p>
<p>If you wanted to have different initial starting parameters for each of the
linear backgrounds, you should provide a cell array of row vectors, one per
dataset:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bpin</span><span class="w"> </span><span class="p">({[</span><span class="mf">5.5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]},</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">1.2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span>
</pre></div>
</div>
<p>Similarly, if you wanted to fit a linear background to the first two datasets
and a quadratic background to the to the third then you should provide a cell
array of function handles, one per dataset. Note that three parameters are
required for a quadratic background, so you need to give a cell array of
starting values as well.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">({@</span><span class="n">linear_bg</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="n">linear_bg</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="n">quad_bg</span><span class="p">});</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bpin</span><span class="w"> </span><span class="p">({[</span><span class="mf">5.5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]},</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">1.2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span>
</pre></div>
</div>
</section>
<section id="binding-parameters">
<h3><span class="section-number">15.2.3. </span>Binding parameters<a class="headerlink" href="#binding-parameters" title="Permalink to this heading"></a></h3>
<p>You can bind parameters together so that they are always in a fixed ratio. For
example if you wanted the height to always be ten times the standard deviation
of the Gaussian, you set a binding descriptor, which is a cell array that gives
in sequence the bound parameter, the free parameter, and the ratio of the bound
to free parameter:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bind</span><span class="w"> </span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">});</span>
</pre></div>
</div>
<p>This is a particular case of a binding descriptor. More generally, you need to
give the parameter index and the function index for each of the bound and free
parameters. The general syntax of a binding descriptor is:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">{[</span><span class="n">ipar_bound</span><span class="p">,</span><span class="w"> </span><span class="n">ifun_bound</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">ipar_free</span><span class="p">,</span><span class="w"> </span><span class="n">ifun_free</span><span class="p">],</span><span class="w"> </span><span class="n">ratio</span><span class="p">}</span>
</pre></div>
</div>
<p>You can also give more than one binding in one command, by providing a cell
array of binding descriptors. For example, if you want to bind the linear
background constants together in the example above:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bbind</span><span class="w"> </span><span class="p">({[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">});</span>
</pre></div>
</div>
<p>Various defaults apply if you abbreviate the descriptor. For example, if you
don’t give the parameter ratio, then multifit will assume the value determined
by the initial parameter values in <code class="docutils literal notranslate"><span class="pre">set_pin</span></code> and <code class="docutils literal notranslate"><span class="pre">set_bpin</span></code>. If you don’t give
the bound function index then it is assumed that you mean that the binding
applies for all functions of that type (i.e. the type being foreground or
background functions). The syntax enables complex bindings to be created in
quite a succinct form, and you should navigate to the help for <code class="docutils literal notranslate"><span class="pre">set_bind</span></code>
(foreground function bindings) and <code class="docutils literal notranslate"><span class="pre">set_bbind</span></code> (background function bindings)
from <code class="docutils literal notranslate"><span class="pre">doc</span> <span class="pre">sqw/multifit</span></code>. You can also accumulate bindings to ones you’ve
already set using <code class="docutils literal notranslate"><span class="pre">add_bind</span></code> and <code class="docutils literal notranslate"><span class="pre">add_bbind</span></code>.</p>
</section>
<section id="semi-global-fits">
<h3><span class="section-number">15.2.4. </span>Semi-global fits<a class="headerlink" href="#semi-global-fits" title="Permalink to this heading"></a></h3>
<p>So far we’ve seen how to have a global ‘foreground’ function that applies to all
datasets (a Gaussian in the above, but it could be a model for <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span>)
together with independent ‘background’ functions for each dataset. A commonly
encountered requirement is to have a model for the foreground where some
parameters are global and other are local - for example a single exchange
constant in a model for spin waves but independent intensities and inverse
lifetimes. To achieve this you can set the background model to be local rather
than global, just as teh default is for the background functions. Then you can
use binding s to link a parameter across all datasets. For example, returning to
our Gaussian foreground model, if we want the position constrained to be the
same (but not necessarily zero) for all datasets, but the height and standard
deviation allowed to be different:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">multifit</span><span class="w"> </span><span class="p">(</span><span class="n">my_data</span><span class="p">);</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_local_foreground</span><span class="p">;</span><span class="w">    </span><span class="c">% override the default</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_fun</span><span class="w"> </span><span class="p">(@</span><span class="n">gauss</span><span class="p">);</span><span class="w">        </span><span class="c">% sets every function to be Gaussian</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_pin</span><span class="w"> </span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]);</span><span class="w">  </span><span class="c">% same initial parameter for all functions</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kk</span><span class="p">.</span><span class="n">set_bind</span><span class="w"> </span><span class="p">({</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]});</span><span class="w">  </span><span class="c">% bind parameter 2 of all functions</span>
</pre></div>
</div>
<p>The syntax of the last function means that parameter 2 of all foreground
functions is bound to parmaeter 2 of the first function. The ratio will be unity
because they were all initialised to the same value.</p>
</section>
</section>
<section id="summary-of-commands-with-multifit">
<h2><span class="section-number">15.3. </span>Summary of commands with multifit<a class="headerlink" href="#summary-of-commands-with-multifit" title="Permalink to this heading"></a></h2>
<p>The command set and the inputs they take is considerably richer than the taster
that has been given above. The <code class="docutils literal notranslate"><span class="pre">multifit</span></code> help in Matlab that you invoke by
typing <code class="docutils literal notranslate"><span class="pre">doc</span> <span class="pre">sqw/multifit</span></code> (and any of the variants for <code class="docutils literal notranslate"><span class="pre">d1d</span></code>, <code class="docutils literal notranslate"><span class="pre">d2d</span></code>,
… objects, and <code class="docutils literal notranslate"><span class="pre">multifit_func</span></code>, <code class="docutils literal notranslate"><span class="pre">multifit_sqw</span></code>, <code class="docutils literal notranslate"><span class="pre">multifit_sqw_sqw</span></code>) is
the gateway to discovering more about the commands and links to example fitting
functions. The summary of the commands is as follows:</p>
<p>To set data:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">set_data</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">clearing</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="n">datasets</span>
<span class="n">append_data</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Append</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">datasets</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">datasets</span>
<span class="n">remove_data</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nb">Remove</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">dataset</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">replace_data</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Replace</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">dataset</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>To mask data points:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">set_mask</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Mask</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">points</span>
<span class="n">add_mask</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Mask</span><span class="w"> </span><span class="n">additional</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">points</span>
<span class="n">clear_mask</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="n">masking</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">dataset</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>To set fitting functions:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">set_fun</span><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="nb">functions</span>
<span class="n">clear_fun</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="nb">functions</span>

<span class="n">set_bfun</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="nb">functions</span>
<span class="n">clear_bfun</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="nb">functions</span>
</pre></div>
</div>
<p>To set initial function parameter values:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">set_pin</span><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">parameters</span>
<span class="n">clear_pin</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="nb">functions</span>

<span class="n">set_bpin</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">parameters</span>
<span class="n">clear_bpin</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="nb">functions</span>
</pre></div>
</div>
<p>To set which parameters are fixed or free:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">set_free</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">fix</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">parameters</span>
<span class="n">clear_free</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="nb">all</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">sets</span>

<span class="n">set_bfree</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">fix</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">parameters</span>
<span class="n">clear_bfree</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="nb">all</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">sets</span>
</pre></div>
</div>
<p>To bind parameters:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">set_bind</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Bind</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="nb">values</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="n">ratios</span>
<span class="n">add_bind</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">bindings</span>
<span class="n">clear_bind</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="nb">functions</span>

<span class="n">set_bbind</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Bind</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="nb">values</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="n">ratios</span>
<span class="n">add_bbind</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">bindings</span>
<span class="n">clear_bbind</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="nb">functions</span>
</pre></div>
</div>
<p>To set functions as operating globally or local to a single dataset</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">set_global_foreground</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Specify</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="k">function</span>
<span class="n">set_local_foreground</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Specify</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="n">set_global_background</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Specify</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="k">function</span>
<span class="n">set_local_background</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Specify</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>To fit or simulate:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">fit</span><span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">Fit</span><span class="w"> </span><span class="n">data</span>
<span class="n">simulate</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">Simulate</span><span class="w"> </span><span class="n">datasets</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="nb">values</span>
</pre></div>
</div>
<p>Fit control parameters and other options:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">set_options</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">options</span>
<span class="n">get_options</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="nb">values</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="nb">more</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">options</span>
</pre></div>
</div>
</section>
<section id="fitting-functions">
<h2><span class="section-number">15.4. </span>Fitting functions<a class="headerlink" href="#fitting-functions" title="Permalink to this heading"></a></h2>
<p>Several <code class="docutils literal notranslate"><span class="pre">multifit</span></code> variants are available for <code class="docutils literal notranslate"><span class="pre">sqw</span></code> and <code class="docutils literal notranslate"><span class="pre">d1d</span></code>, <code class="docutils literal notranslate"><span class="pre">d2d</span></code>,
<code class="docutils literal notranslate"><span class="pre">d3d</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">d4d</span></code> objects. The only substantive difference is the form of the
fit functions they require: either they are functions of the numeric values of
the plot coordinates, or they are function of wavevector in reciprocal lattice
units and energy.</p>
<section id="multifit-function">
<h3><span class="section-number">15.4.1. </span>multifit function<a class="headerlink" href="#multifit-function" title="Permalink to this heading"></a></h3>
<p>This method is identical to <code class="docutils literal notranslate"><span class="pre">multifit_func</span></code>.</p>
<ul class="simple">
<li><p>Foreground function(s): function of the plot axes <code class="docutils literal notranslate"><span class="pre">x1</span></code>, <code class="docutils literal notranslate"><span class="pre">x2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">xn</span></code>
for as many x arrays as there are plot axes</p></li>
<li><p>Background function(s): functions of the plot axes <code class="docutils literal notranslate"><span class="pre">x1</span></code>, <code class="docutils literal notranslate"><span class="pre">x2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">xn</span></code>
for as many x arrays as there are plot axes</p></li>
</ul>
<p>The general form of a function of plot axis coordinates is:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">my_function</span><span class="w"> </span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="c">, xn, pars)</span>
</pre></div>
</div>
<p>or, more generally:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">my_function</span><span class="w"> </span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="c">, xn, pars, c1, c2, ... cn)</span>
</pre></div>
</div>
<p>where</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">x1</span></code>, <code class="docutils literal notranslate"><span class="pre">x2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">xn</span></code> Arrays of x coordinates along each of the n
dimensions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pars</span></code> Parameters needed by the function</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c1</span></code>, <code class="docutils literal notranslate"><span class="pre">c2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">cn</span></code> Any further constant arguments needed by the
function. For example, they could be the filenames of lookup tables</p></li>
</ul>
</section>
<section id="multifit-func">
<h3><span class="section-number">15.4.2. </span>multifit_func<a class="headerlink" href="#multifit-func" title="Permalink to this heading"></a></h3>
<p>This method is identical to <code class="docutils literal notranslate"><span class="pre">multifit</span></code>.</p>
</section>
<section id="multifit-sqw">
<h3><span class="section-number">15.4.3. </span>multifit_sqw<a class="headerlink" href="#multifit-sqw" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>Foreground function(s): functions of <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span></p></li>
<li><p>Background function(s): functions of the plot axes <code class="docutils literal notranslate"><span class="pre">x1</span></code>, <code class="docutils literal notranslate"><span class="pre">x2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">xn</span></code>
for as many x arrays as there are plot axes</p></li>
</ul>
<p>The general form of a model for <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span> is:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">weight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sqwfunc</span><span class="w"> </span><span class="p">(</span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
<p>or, more generally:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">weight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sqwfunc</span><span class="w"> </span><span class="p">(</span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="c">, cn)</span>
</pre></div>
</div>
<p>where</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">qh</span></code>, <code class="docutils literal notranslate"><span class="pre">qk</span></code>, <code class="docutils literal notranslate"><span class="pre">ql</span></code>, <code class="docutils literal notranslate"><span class="pre">en</span></code> Arrays containing the coordinates of a set of
points</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> Vector of parameters needed by the model e.g. [A, js, gam] as intensity,
exchange, lifetime</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c1</span></code>, <code class="docutils literal notranslate"><span class="pre">c2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">cn</span></code> Other constant parameters e.g. file name for
look-up table weight Array containing calculated spectral weight</p></li>
</ul>
<p>The general form of a function of plot axis coordinates is:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">my_function</span><span class="w"> </span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="c">, xn, pars)</span>
</pre></div>
</div>
<p>or, more generally:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">my_function</span><span class="w"> </span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="c">, xn, pars, c1, c2, ..., cn)</span>
</pre></div>
</div>
<p>where</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">x1</span></code>, <code class="docutils literal notranslate"><span class="pre">x2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">xn</span></code> Arrays of x coordinates along each of the n
dimensions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pars</span></code> Parameters needed by the function</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c1</span></code>, <code class="docutils literal notranslate"><span class="pre">c2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">cn</span></code> Any further constant arguments needed by the
function. For example, they could be the filenames of lookup tables</p></li>
</ul>
</section>
<section id="multifit-sqw-sqw">
<h3><span class="section-number">15.4.4. </span>multifit_sqw_sqw<a class="headerlink" href="#multifit-sqw-sqw" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>Foreground function(s): functions of <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span></p></li>
<li><p>Background function(s): functions of <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span></p></li>
</ul>
<p>The general form of a model for <span class="math notranslate nohighlight">\(S(\mathbf{Q}, \omega)\)</span> is:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">weight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sqwfunc</span><span class="w"> </span><span class="p">(</span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
<p>or, more generally:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">weight</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sqwfunc</span><span class="w"> </span><span class="p">(</span><span class="n">qh</span><span class="p">,</span><span class="w"> </span><span class="n">qk</span><span class="p">,</span><span class="w"> </span><span class="n">ql</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="p">..)</span>
</pre></div>
</div>
<p>where</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">qh</span></code>, <code class="docutils literal notranslate"><span class="pre">qk</span></code>, <code class="docutils literal notranslate"><span class="pre">ql</span></code>, <code class="docutils literal notranslate"><span class="pre">en</span></code> Arrays containing the coordinates of a set of
points</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code> Vector of parameters needed by the model e.g. [A, js, gam] as intensity,
exchange, lifetime</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c1</span></code>, <code class="docutils literal notranslate"><span class="pre">c2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">cn</span></code> Other constant parameters e.g. file name for
look-up table weight Array containing calculated spectral weight</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">weight</span></code> Array containing calculated spectral weight</p></li>
</ul>
</section>
</section>
<section id="parallel-fitting">
<h2><span class="section-number">15.5. </span>Parallel fitting<a class="headerlink" href="#parallel-fitting" title="Permalink to this heading"></a></h2>
<p>It is possible to use <code class="docutils literal notranslate"><span class="pre">multifit</span></code> and its derivatives (<code class="docutils literal notranslate"><span class="pre">tobyfit</span></code>,
<code class="docutils literal notranslate"><span class="pre">multifit_sqw</span></code>, <code class="docutils literal notranslate"><span class="pre">multifit_sqw_sqw</span></code>) in parallel (see
<a class="reference internal" href="Parallel.html#running-horace-in-parallel"><span class="std std-ref">Running Horace in Parallel</span></a> for more info) by either
enabling HPC options through</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">hpc</span><span class="p">(</span><span class="s">&#39;on&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>or by setting <code class="docutils literal notranslate"><span class="pre">parallel_multifit</span></code> directly in the <code class="docutils literal notranslate"><span class="pre">hpc_config</span></code> (see
<a class="reference internal" href="Changing_Horace_settings.html#hpc-config"><span class="std std-ref">Changing Horace settings</span></a>)</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">hc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">hpc_config</span><span class="p">;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">hc</span><span class="p">.</span><span class="n">parallel_multifit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</pre></div>
</div>
<p>Parallel <code class="docutils literal notranslate"><span class="pre">multifit</span></code> decomposes the objects passed in into slices which are
distributed between the processors. E.g. if we are fitting three <code class="docutils literal notranslate"><span class="pre">IX_dataset</span></code>
objects with 100 points between two processors, each processor will receive 50
points from each <code class="docutils literal notranslate"><span class="pre">IX_dataset</span></code>.</p>
<p>This decomposition is performed differently for each of the three classes of
fittable objects for each they are divided into <code class="docutils literal notranslate"><span class="pre">N_items/N_procs</span></code>:</p>
<ul class="simple">
<li><p>For <code class="docutils literal notranslate"><span class="pre">sqw</span></code> objects, the items are pixels</p></li>
<li><p>For <code class="docutils literal notranslate"><span class="pre">dnd</span></code> objects, the items are whole bins.</p></li>
<li><p>For <code class="docutils literal notranslate"><span class="pre">IX_dataset</span></code> objects, the items are points.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the fitting is run with the <code class="docutils literal notranslate"><span class="pre">-ave</span></code> option on an <code class="docutils literal notranslate"><span class="pre">sqw</span></code>, then the
decomposition will not split bins, but will distribute whole bins, which may
lead to load imbalance.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Simulation.html" class="btn btn-neutral float-left" title="14. Simulation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Tobyfit.html" class="btn btn-neutral float-right" title="16. Tobyfit" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2006-2025, STFC RAL.
      <span class="lastupdated">Last updated on Jun 4, 2025, 1:39:40 PM.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
<br><br>
<a href="https://github.com/pace-neutrons/Horace/edit/master/documentation/user_docs/docs/manual/Multifit.rst">Click here to edit</a> or <a href="https://github.com/pace-neutrons/Horace/edit/master/documentation/user_docs/docs/new_page.rst">Click here to add new page</a> (requires <a href="https://github.com/login">GitHub account</a>).
<br>
For more info on editing <a href="../Contributing.html">click here</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>