#!groovy

@Library('PACE-shared-lib') import pace.common.PipeLineInfo

pli = new PipeLineInfo(env.JOB_BASE_NAME)

properties([
  parameters([
    string(
      defaultValue: pli.branch_name,
      description: 'The name of the branch to build. Affects non-PR builds only. *',
      name: 'BRANCH_NAME',
      trim: true
    ),
    string(
      defaultValue: pli.release_type,
      description: 'The type of the build e.g. "nightly", "release", "pull_request", "benchmark". *',
      name: 'RELEASE_TYPE',
      trim: true
    ),
    string(
      defaultValue: utilities.get_agent(pli.os),
      description: 'The agent to execute the pipeline on. *',
      name: 'AGENT',
      trim: true
    ),
    string(
      defaultValue: '',
      description: 'The release number of the Matlab to load e.g. R2019b.',
      name: 'MATLAB_VERSION',
      trim: true
    ),
    string(
      defaultValue: '',
      description: 'The version of CMake to run the build with. Affects Linux builds only.',
      name: 'CMAKE_VERSION',
      trim: true
    ),
    string(
      defaultValue: '',
      description: 'The version of GCC to build with. Affects Linux builds only.',
      name: 'GCC_VERSION',
      trim: true
    ),
    string(
      defaultValue: '',
      description: 'The version of Python to build with. Affects Linux builds only.',
      name: 'PYTHON_VERSION',
      trim: true
    ),
    string(
      defaultValue: '',
      description: 'The year of the version of Visual Studio to build with. Affects Windows builds only.',
      name: 'VS_VERSION',
      trim: true
    ),
    string(
      defaultValue: '',
      description: 'The version of CppCheck tooling to load to provide the code-style checks.',
      name: 'CPPCHECK_VERSION',
      trim: true
    ),
    booleanParam(
      defaultValue: true,
      description: 'If this pipeline is to build docs.',
      name: 'BUILD_DOCS'
    ),
    booleanParam(
      defaultValue: false,
      description: 'If this pipeline is to run benchmarks.',
      name: 'RUN_BENCHMARKS'
    )
  ])
])

if (env.BRANCH_NAME) {
  currentBuild.description = "Branch: ${env.BRANCH_NAME}"
} else if (env.PR_NUMBER) {
  currentBuild.displayName = "#${env.BUILD_NUMBER} PR-${env.PR_NUMBER}"
  currentBuild.description = "Git-SHA: ${env.PR_COMMIT_SHA.take(7)}"
}

Boolean run_build_stage = !(env?.PR_LABELS =~ "do-not-build")
Boolean run_test_stage = !(env?.PR_LABELS =~ "(do-not-build|do-not-test)") && env?.RELEASE_TYPE != 'benchmark'
Boolean run_benchmark_stage = env?.RELEASE_TYPE == 'benchmark' || env?.RUN_BENCHMARK

pipeline {
  agent {
    label env.AGENT
  }

  environment {
    // SL7 nodes had matlab/R20xx[ab] + matlab/2020b. Rocky8 nodes do not, only matlab/20xx[ab]
    // removing the R here from the pipeline library standard version so as not to break other library dependent pipelines
    MATLAB_VERSION = utilities.get_param('MATLAB_VERSION', pli.matlab_release)
    MATLAB_MODULE = utilities.get_param('MATLAB_VERSION', pli.matlab_release.minus('R'))
    CMAKE_VERSION = utilities.get_param('CMAKE_VERSION', '3.26')
    GCC_VERSION = utilities.get_param('GCC_VERSION', '10')
    PYTHON_VERSION = utilities.get_param('PYTHON_VERSION', '3.8')
    VS_VERSION = utilities.get_param('VS_VERSION', '2019')
    CPPCHECK_VERSION = utilities.get_param('CPPCHECK_VERSION', '2.13')
    BUILD_DOCS = utilities.get_param('BUILD_DOCS', 'true')
  }


  stages {

    stage('Notify') {
      steps {
        script {
          if (env.PR_LABELS) {
            echo "Found PR labels: ${env.PR_LABELS}"
          }
        }
        post_github_status("pending", "The build is running")
      }
    }

    stage('Configure') {
      steps {
        script {
          sh '''
              module load python/\$PYTHON_VERSION &&
              export PATH=${PATH}:~/.local/bin &&
              module load cmake/\$CMAKE_VERSION &&
              module load matlab/\$MATLAB_MODULE &&
              module load gcc/\$GCC_VERSION &&
              module load cppcheck/\$CPPCHECK_VERSION &&
              ./tools/build_config/build.sh \
                --cmake_flags \"-DHorace_RELEASE_TYPE=\$RELEASE_TYPE\" \
                --matlab_release \$MATLAB_VERSION \
                --print_versions \
                --configure
              '''
        }
      }
    }

    stage('Build') {
      when {
        expression {
          run_build_stage == true
        }
      }
      steps {
        script {
          sh '''
              module load cmake/\$CMAKE_VERSION &&
              module load matlab/\$MATLAB_MODULE &&
              module load gcc/\$GCC_VERSION &&
              ./tools/build_config/build.sh --build
            '''
        }
      }
    }

    stage('Test') {
      when {
        expression {
          run_test_stage == true
        }
      }
      steps {
        script {
          if (isUnix()) {
            sh '''
              module load cmake/\$CMAKE_VERSION &&
              module load matlab/\$MATLAB_MODULE &&
              module load gcc/\$GCC_VERSION &&
              matlab -r "parpool('local')"
              cd _test/test_mpi/
              matlab -r "setSchedulerMessageHandler(@disp)
                         cluster = parcluster('local');
                         job = createJob (cluster);
                         createTask(job, @sum, 1, {[1 1]});
                         submit(job);
                         wait(job);
                         out = fetchOutputs(job)"
              matlab -r "addpath('../../build/local_init/'); horace_on; hc=hor_config; hc.init_tests = true; runtests test_ParpoolMPI_Framework.m"
            '''
          }
          else {
            powershell './tools/build_config/build.ps1 -test'
          }
        }
      }
    }
  }

  post {
    cleanup {
      deleteDir()
    }
  }
}
